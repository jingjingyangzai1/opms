{% extends "base.html" %}

{% block title %}æ•°æ®åº“ç®¡ç† - è¿ç»´ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    .db-manager-main {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px);
        background: #f0f0f0;
        padding: 10px;
        gap: 10px;
    }
    
    /* å·¥å…·æ  */
    .db-toolbar {
        background: white;
        border-radius: 4px;
        padding: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .db-toolbar-btn {
        padding: 6px 12px;
        border: 1px solid #d0d0d0;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .db-toolbar-btn:hover {
        background: #f0f0f0;
        border-color: #00d4ff;
    }
    
    .db-toolbar-btn.active {
        background: #e6f7ff;
        border-color: #00d4ff;
        color: #00d4ff;
    }
    
    /* ä¸»ä½“åŒºåŸŸ */
    .db-manager-body {
        display: flex;
        flex: 1;
        gap: 10px;
        overflow: hidden;
    }
    
    /* å·¦ä¾§è¿æ¥é¢æ¿ */
    .db-connection-panel {
        width: 250px;
        background: white;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .db-connection-header {
        padding: 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
        color: #495057;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .db-connection-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }
    
    .db-connection-item {
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }
    
    .db-connection-item:hover {
        background: #f0f0f0;
    }
    
    .db-connection-item.active {
        background: #e6f7ff;
        color: #00d4ff;
    }
    
    .db-connection-icon {
        width: 16px;
        height: 16px;
    }
    
    /* å³ä¾§å†…å®¹åŒºåŸŸ */
    .db-content-area {
        flex: 1;
        background: white;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .db-content-tabs {
        padding: 8px 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        gap: 20px;
    }
    
    .db-content-tab {
        padding: 6px 12px;
        cursor: pointer;
        color: #666;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }
    
    .db-content-tab.active {
        color: #1890ff;
        border-bottom-color: #1890ff;
    }
    
    .db-content-pane {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
    }
    
    /* å¯¹è±¡åˆ—è¡¨åŒºåŸŸ */
    .db-object-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e8e8e8;
    }
    
    .db-object-list-actions {
        display: flex;
        gap: 8px;
    }
    
    .db-action-btn {
        padding: 6px 12px;
        border: 1px solid #d9d9d9;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        transition: all 0.2s;
    }
    
    .db-action-btn:hover {
        border-color: #1890ff;
        color: #1890ff;
    }
    
    /* SQLç¼–è¾‘å™¨ */
    .db-sql-editor-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 10px;
    }
    
    .db-sql-editor {
        flex: 1;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 14px;
        padding: 12px;
        resize: none;
    }
    
    .db-sql-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* ç»“æœè¡¨æ ¼å®¹å™¨ */
    #sqlResultArea {
        margin-top: 16px;
        width: 100%;
        overflow: visible;
    }
    
    /* è¡¨æ ¼æ»šåŠ¨å®¹å™¨ - å¼ºåˆ¶å¯ç”¨æ»šåŠ¨ */
    #sqlResultScrollContainer {
        overflow-x: scroll !important;
        overflow-y: auto !important;
        max-height: 800px !important;
        width: 100% !important;
        position: relative !important;
        display: block !important;
        scrollbar-width: auto !important;
        scrollbar-color: #00d4ff rgba(240, 240, 240, 0.9) !important;
        -webkit-overflow-scrolling: touch !important;
        border: 2px solid #e0e0e0 !important;
        border-radius: 8px !important;
        background: #fafafa !important;
    }
    
    /* å®¹å™¨å†…çš„è¡¨æ ¼å¿…é¡»èƒ½å¤Ÿè¶…å‡ºå®¹å™¨å®½åº¦ */
    #sqlResultScrollContainer table {
        width: max-content !important;
        min-width: 100% !important;
        table-layout: fixed !important;
        border-collapse: separate !important;
        border-spacing: 0 !important;
        display: table !important;
        margin: 0 !important;
    }
    
    /* å•å…ƒæ ¼å†…å®¹ä¸æ¢è¡Œï¼Œå¼ºåˆ¶ä¿æŒå•è¡Œ - å…³é”®è®¾ç½®ï¼ */
    #sqlResultScrollContainer th,
    #sqlResultScrollContainer td {
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        max-width: none !important;
        min-width: 250px !important;
        width: 250px !important;
        padding: 14px 16px !important;
        vertical-align: middle !important;
        box-sizing: border-box !important;
        line-height: 1.8 !important;
    }
    
    /* è¡¨å¤´åˆ—å®½ - å¯è°ƒæ•´å¤§å° */
    #sqlResultScrollContainer thead th {
        min-width: 250px !important;
        max-width: none !important;
        width: 250px !important;
        padding: 14px 16px !important;
        position: sticky !important;
        top: 0 !important;
        background: white !important;
        z-index: 10 !important;
        font-weight: 600 !important;
        border-bottom: 2px solid #e8e8e8 !important;
        cursor: col-resize !important;
        user-select: none !important;
        line-height: 1.8 !important;
    }
    
    /* è¡¨å¤´å³ä¾§è°ƒæ•´æŠŠæ‰‹ */
    #sqlResultScrollContainer thead th::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        cursor: col-resize;
        background: transparent;
    }
    
    #sqlResultScrollContainer thead th:hover::after {
        background: #1890ff;
        opacity: 0.3;
    }
    
    /* è¡¨æ ¼å•å…ƒæ ¼è¾¹æ¡† */
    #sqlResultScrollContainer td {
        border-right: 1px solid #f0f0f0 !important;
        border-bottom: 1px solid #f0f0f0 !important;
    }
    
    #sqlResultScrollContainer th {
        border-right: 1px solid #e8e8e8 !important;
    }
    
    /* åˆ†é¡µæ§ä»¶ */
    #sqlResultPagination {
        margin-top: 12px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 20px;
        padding: 10px;
        background: #fafafa;
        border-radius: 4px;
        border: 1px solid #e8e8e8;
        flex-wrap: wrap;
    }
    
    .pagination-info {
        font-size: 14px;
        color: #666;
    }
    
    .pagination-buttons {
        display: flex;
        gap: 8px;
    }
    
    .pagination-btn {
        padding: 6px 12px;
        border: 1px solid #d0d0d0;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        color: #666;
        transition: all 0.2s;
    }
    
    .pagination-btn:hover {
        background: #f0f0f0;
        border-color: #00d4ff;
        color: #00d4ff;
    }
    
    .pagination-btn.active {
        background: #e6f7ff;
        border-color: #00d4ff;
        color: #00d4ff;
        font-weight: bold;
    }
    
    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .pagination-btn:disabled:hover {
        background: white;
        border-color: #d0d0d0;
        color: #666;
    }
    
    #sqlResultArea * {
        color: #333 !important;
    }
    
    #sqlResultArea th,
    #sqlResultArea td {
        color: #333 !important;
    }
    
    /* ç»“æœè¡¨æ ¼ */
    .db-result-table,
    #sqlResultTable {
        border-collapse: collapse !important;
        background: white;
        font-size: 13px;
        display: table !important;
        width: auto !important;
        min-width: 100% !important;
        table-layout: auto !important;
    }
    
    /* ç¡®ä¿è¡¨æ ¼è¡Œå’Œå•å…ƒæ ¼æ­£ç¡®æ˜¾ç¤º */
    #sqlResultTable tr {
        display: table-row !important;
    }
    
    #sqlResultTable th,
    #sqlResultTable td {
        display: table-cell !important;
    }
    
    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ - é€‚ç”¨äºè¡¨æ ¼å®¹å™¨ */
    #sqlResultScrollContainer::-webkit-scrollbar {
        width: 20px !important;
        height: 20px !important;
    }
    
    #sqlResultScrollContainer::-webkit-scrollbar-track {
        background: linear-gradient(90deg, #f0f0f0, #e8e8e8) !important;
        -webkit-background: linear-gradient(90deg, #f0f0f0, #e8e8e8) !important;
        border-radius: 10px !important;
        border: 2px solid #d0d0d0 !important;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.1) !important;
        -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.1) !important;
        -moz-box-shadow: inset 0 0 5px rgba(0,0,0,0.1) !important;
    }
    
    #sqlResultScrollContainer::-webkit-scrollbar-thumb {
        background: linear-gradient(45deg, #00d4ff, #0099cc, #0077aa) !important;
        -webkit-background: linear-gradient(45deg, #00d4ff, #0099cc, #0077aa) !important;
        border-radius: 10px !important;
        border: 3px solid #fff !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
        -webkit-box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
        -moz-box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
        cursor: grab !important;
        min-height: 30px !important;
        min-width: 30px !important;
    }
    
    #sqlResultScrollContainer::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(45deg, #00b8e6, #0088bb, #006699) !important;
        -webkit-background: linear-gradient(45deg, #00b8e6, #0088bb, #006699) !important;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4) !important;
        -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4) !important;
        -moz-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4) !important;
        cursor: grab !important;
        -webkit-transform: scale(1.05) !important;
        -moz-transform: scale(1.05) !important;
        -ms-transform: scale(1.05) !important;
        -o-transform: scale(1.05) !important;
        transform: scale(1.05) !important;
    }
    
    #sqlResultScrollContainer::-webkit-scrollbar-thumb:active {
        background: linear-gradient(45deg, #0088bb, #006699, #004477) !important;
        -webkit-background: linear-gradient(45deg, #0088bb, #006699, #004477) !important;
        cursor: grabbing !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
        -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
        -moz-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
    }
    
    #sqlResultScrollContainer::-webkit-scrollbar-corner {
        background: linear-gradient(135deg, #f0f0f0, #e8e8e8) !important;
        -webkit-background: linear-gradient(135deg, #f0f0f0, #e8e8e8) !important;
        border-radius: 10px !important;
    }
    
    /* IE/Edge å…¼å®¹æ€§ */
    @supports (-ms-ime-align: auto) {
        #sqlResultScrollContainer {
            -ms-overflow-style: auto !important;
        }
    }
    
    /* Firefox æ»šåŠ¨æ¡æ ·å¼ */
    #sqlResultScrollContainer {
        scrollbar-width: auto !important;
        scrollbar-color: #00d4ff #f0f0f0 !important;
    }
    
    .db-result-table thead,
    #sqlResultThead {
        display: table-header-group;
    }
    
    .db-result-table tbody,
    #sqlResultTbody {
        display: table-row-group;
    }
    
    .db-result-table th,
    #sqlResultThead th,
    .db-result-table thead th {
        background: #fafafa;
        padding: 10px;
        border-bottom: 1px solid #e8e8e8;
        text-align: left;
        font-weight: 500;
        color: #333;
        display: table-cell;
    }
    
    .db-result-table td,
    #sqlResultTbody td,
    .db-result-table tbody td {
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
        white-space: nowrap;
        display: table-cell;
        color: #333;
        background: white;
    }
    
    .db-result-table th,
    #sqlResultThead th,
    .db-result-table thead th {
        white-space: nowrap;
    }
    
    .db-result-table tr,
    #sqlResultThead tr,
    #sqlResultTbody tr,
    .db-result-table thead tr,
    .db-result-table tbody tr {
        display: table-row;
    }
    
    .db-result-table tr:hover,
    #sqlResultTbody tr:hover,
    .db-result-table tbody tr:hover {
        background: #f5f5f5;
    }
    
    /* ç©ºçŠ¶æ€ */
    .db-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
    }
    
    .db-empty-icon {
        font-size: 48px;
    }
    
    /* æ ‘å½¢ç»“æ„æ ·å¼ */
    .db-tree-node {
        margin: 2px 0;
    }
    
    .db-tree-item {
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
        user-select: none;
    }
    
    .db-expand-icon {
        display: inline-block;
        width: 12px;
        font-size: 10px;
        transition: transform 0.2s;
        color: #666;
    }
    
    .db-tree-children {
        margin-left: 12px;
        border-left: 1px solid #e0e0e0;
    }
    
    .db-table-item {
        padding: 4px 8px 4px 24px;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
        user-select: none;
    }
    
    .db-table-item:hover {
        background: #f0f0f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 0; margin: 0;">
    <div class="row" style="margin: 0;">
        <!-- ä¾§è¾¹æ  -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky pt-0">
                <div class="text-center mb-1">
                    <div style="font-size: 28px; color: #00d4ff; margin-bottom: 4px;">
                        <i class="fas fa-database"></i>
                    </div>
                    <h6 class="text-white" style="font-size: 1rem;">è¿ç»´ç®¡ç†ç³»ç»Ÿ</h6>
                </div>
                
                <!-- å¯¼èˆªèœå• -->
                <ul class="nav flex-column" style="font-size: 1.1rem;">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('training_assets') }}">
                            <i class="fas fa-database me-2"></i>è®­ç»ƒç³»ç»Ÿèµ„äº§
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('physical_servers') }}">
                            <i class="fas fa-server me-2"></i>ä¸»æ§ç‰©ç†æœåŠ¡å™¨
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('database_manager') }}">
                            <i class="fas fa-code me-2"></i>æ•°æ®åº“ç®¡ç†
                        </a>
                    </li>
                    <h6 class="text-white-50 mb-3 mt-3">ç”¨æˆ·ç®¡ç†</h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('users') }}">
                                <i class="fas fa-users me-2"></i>ç”¨æˆ·ç®¡ç†
                            </a>
                        </li>
                    </ul>
                </ul>
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="col-md-9 ms-sm-auto col-lg-10" style="padding: 0.5rem; margin: 0;">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-0 pb-0 mb-0">
                <h1 class="h2 text-white" style="margin-top: 0; margin-bottom: 0; font-size: 2rem;">
                    <i class="fas fa-database me-2" style="color: #00d4ff;"></i>æ•°æ®åº“ç®¡ç†
                </h1>
                <div class="btn-toolbar mb-0 mb-md-0">
                    <div class="btn-group me-2">
                        <span class="text-white me-2 ms-2" style="font-size: 1.1rem;">æ¬¢è¿, {{ current_user.name }}</span>
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                            <i class="fas fa-sign-out-alt me-1"></i>é€€å‡º
                        </a>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®åº“ç®¡ç†å™¨ -->
            <div class="db-manager-main">
                <!-- å·¥å…·æ  -->
                <div class="db-toolbar">
                    <button class="db-toolbar-btn" onclick="showConnectModal()">
                        <i class="fas fa-plug"></i>
                        <span>è¿æ¥</span>
                    </button>
                    <button class="db-toolbar-btn" onclick="showQueryEditor()">
                        <i class="fas fa-code"></i>
                        <span>æŸ¥è¯¢</span>
                    </button>
                    <button class="db-toolbar-btn active" onclick="showObjects('table')">
                        <i class="fas fa-table"></i>
                        <span>è¡¨</span>
                    </button>
                    <button class="db-toolbar-btn" onclick="showObjects('view')">
                        <i class="fas fa-th"></i>
                        <span>è§†å›¾</span>
                    </button>
                    <button class="db-toolbar-btn" onclick="showObjects('function')">
                        <i class="fas fa-function"></i>
                        <span>å‡½æ•°</span>
                    </button>
                    <button class="db-toolbar-btn" onclick="showSQL()">
                        <i class="fas fa-terminal"></i>
                        <span>SQL</span>
                    </button>
                </div>

                <!-- ä¸»ä½“åŒºåŸŸ -->
                <div class="db-manager-body">
                    <!-- å·¦ä¾§ï¼šè¿æ¥é¢æ¿ -->
                    <div class="db-connection-panel">
                        <div class="db-connection-header">
                            <span>æˆ‘çš„è¿æ¥</span>
                            <button onclick="showConnectModal()" style="border: none; background: none; cursor: pointer;">
                                <i class="fas fa-plus text-primary"></i>
                            </button>
                        </div>
                        <div class="db-connection-list" id="connectionList">
                            <div class="db-empty-state">
                                <div class="db-empty-icon">ğŸ“¡</div>
                                <div>æš‚æ— è¿æ¥ï¼Œç‚¹å‡»å³ä¸Šè§’ + åˆ›å»ºè¿æ¥</div>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šå†…å®¹åŒºåŸŸ -->
                    <div class="db-content-area">
                        <div class="db-content-tabs" id="contentTabs">
                            <div class="db-content-tab active" onclick="switchContentTab('objects')">å¯¹è±¡</div>
                            <div class="db-content-tab" onclick="switchContentTab('sql')">SQL</div>
                        </div>

                        <div class="db-content-pane">
                            <!-- å¯¹è±¡åˆ—è¡¨ -->
                            <div id="tabObjects">
                                <div class="db-object-list-header">
                                    <h5 style="margin: 0; font-size: 16px;">åç§°</h5>
                                    <div class="db-object-list-actions" id="objectActions">
                                        <button class="db-action-btn" onclick="openObject()">
                                            <i class="fas fa-folder-open"></i>æ‰“å¼€è¡¨
                                        </button>
                                        <button class="db-action-btn" onclick="designObject()">
                                            <i class="fas fa-pencil-alt"></i>è®¾è®¡è¡¨
                                        </button>
                                        <button class="db-action-btn" onclick="createObject()">
                                            <i class="fas fa-plus"></i>æ–°å»ºè¡¨
                                        </button>
                                        <button class="db-action-btn" onclick="deleteObject()">
                                            <i class="fas fa-minus" style="color: #f5222d;"></i>åˆ é™¤
                                        </button>
                                    </div>
                                </div>
                                <div id="objectList" class="db-empty-state">
                                    <div class="db-empty-icon">ğŸ“‹</div>
                                    <div>è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè¿æ¥</div>
                                </div>
                            </div>

                            <!-- SQLç¼–è¾‘å™¨ -->
                            <div id="tabSQL" style="display: none;">
                                <div class="db-sql-editor-container">
                                    <textarea id="sqlEditor" class="db-sql-editor" placeholder="è¾“å…¥SQLè¯­å¥..."></textarea>
                                    <div class="db-sql-toolbar">
                                        <div>
                                            <button class="db-action-btn" onclick="executeSQL()">
                                                <i class="fas fa-play"></i>æ‰§è¡Œ
                                            </button>
                                            <button class="db-action-btn" onclick="clearSQL()">
                                                <i class="fas fa-eraser"></i>æ¸…ç©º
                                            </button>
                                        </div>
                                        <div id="sqlResultStats"></div>
                                    </div>
                                    <div id="sqlResultArea" style="display: none;">
                                        <div id="sqlResultScrollContainer" style="border: 1px solid #e8e8e8; border-radius: 4px; background: white; margin-bottom: 12px;">
                                            <table class="db-result-table" id="sqlResultTable">
                                                <thead id="sqlResultThead"></thead>
                                                <tbody id="sqlResultTbody"></tbody>
                                            </table>
                                        </div>
                                        <!-- åˆ†é¡µæ§ä»¶ -->
                                        <div id="sqlResultPagination" style="display: none;">
                                            <div class="pagination-info" id="paginationInfo"></div>
                                            <div class="pagination-buttons" id="paginationButtons"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- è¿æ¥æ•°æ®åº“æ¨¡æ€æ¡† -->
<div class="modal fade" id="connectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-plug me-2"></i>æ–°å»ºè¿æ¥
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label text-white">è¿æ¥åç§° *</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="connectionName" placeholder="è¾“å…¥è¿æ¥åç§°">
                </div>
                <div class="mb-3">
                    <label class="form-label text-white">æ•°æ®åº“ç±»å‹ *</label>
                    <select class="form-select bg-dark text-white border-secondary" id="dbType">
                        <option value="mysql">MySQL</option>
                        <option value="postgresql">PostgreSQL</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label text-white">ä¸»æœºåœ°å€ *</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="dbHost" placeholder="192.168.1.100">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label text-white">ç«¯å£ *</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" id="dbPort" value="3306">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">æ•°æ®åº“åï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="dbName" placeholder="ç•™ç©ºåˆ™æ˜¾ç¤ºæ‰€æœ‰æ•°æ®åº“">
                    </div>
                </div>
                <div class="mb-3 mt-3">
                    <label class="form-label text-white">ç”¨æˆ·å *</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="dbUsername" placeholder="root">
                </div>
                <div class="mb-3">
                    <label class="form-label text-white">å¯†ç  *</label>
                    <input type="password" class="form-control bg-dark text-white border-secondary" id="dbPassword" placeholder="password">
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="connectDatabase()">
                    <i class="fas fa-plug me-2"></i>è¿æ¥
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let connections = []; // å­˜å‚¨æ‰€æœ‰è¿æ¥
let currentConnection = null;
let currentConnectionId = null;
let databaseType = null;

// åˆ†é¡µç›¸å…³å˜é‡
let currentPage = 1;
const pageSize = 50; // æ¯é¡µæ˜¾ç¤º50è¡Œ
let allRows = []; // å­˜å‚¨æ‰€æœ‰æ•°æ®è¡Œ

// æ˜¾ç¤ºè¿æ¥æ¨¡æ€æ¡†
function showConnectModal() {
    const modal = new bootstrap.Modal(document.getElementById('connectModal'));
    modal.show();
}

// è¿æ¥æ•°æ®åº“
async function connectDatabase() {
    const name = document.getElementById('connectionName').value;
    const dbType = document.getElementById('dbType').value;
    const host = document.getElementById('dbHost').value;
    const port = document.getElementById('dbPort').value;
    const database = document.getElementById('dbName').value || null;
    const username = document.getElementById('dbUsername').value;
    const password = document.getElementById('dbPassword').value;

    if (!name || !dbType || !host || !port || !username || !password) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ');
        return;
    }

    try {
        const response = await axios.post('/api/database/connect', {
            name: name,
            type: dbType,
            host: host,
            port: port,
            database: database,
            username: username,
            password: password
        });

        if (response.data.success) {
            const connection = {
                id: response.data.connection_id,
                name: name,
                type: dbType,
                host: host,
                port: port,
                username: username,
                database: database,
                connected: true
            };
            connections.push(connection);
            updateConnectionList();
            
            // åˆ‡æ¢åˆ°æ–°è¿æ¥
            selectConnection(connection.id);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('connectModal'));
            modal.hide();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('connectionName').value = '';
            document.getElementById('dbHost').value = '';
            document.getElementById('dbPort').value = '3306';
            document.getElementById('dbName').value = '';
            document.getElementById('dbUsername').value = '';
            document.getElementById('dbPassword').value = '';
        } else {
            alert('è¿æ¥å¤±è´¥: ' + response.data.message);
        }
    } catch (error) {
        alert('è¿æ¥å¤±è´¥: ' + (error.response?.data?.message || error.message));
    }
}

// æ›´æ–°è¿æ¥åˆ—è¡¨
function updateConnectionList() {
    const listDiv = document.getElementById('connectionList');
    
    if (connections.length === 0) {
        listDiv.innerHTML = `
            <div class="db-empty-state">
                <div class="db-empty-icon">ğŸ“¡</div>
                <div>æš‚æ— è¿æ¥ï¼Œç‚¹å‡»å³ä¸Šè§’ + åˆ›å»ºè¿æ¥</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    connections.forEach(conn => {
        const icon = conn.type === 'mysql' ? 'ğŸ¬' : 'ğŸ˜';
        html += `
            <div class="db-connection-item" onclick="event.stopPropagation(); selectConnection('${conn.id}')" id="conn-${conn.id}">
                <span class="db-connection-icon">${icon}</span>
                <span style="flex: 1;">${conn.name}</span>
                <span onclick="event.stopPropagation(); deleteConnection('${conn.id}')" 
                      style="padding: 2px 6px; cursor: pointer; color: #ff4d4f; font-size: 12px;"
                      title="åˆ é™¤è¿æ¥">ğŸ—‘ï¸</span>
            </div>
        `;
    });
    listDiv.innerHTML = html;
}


// åŠ è½½æ•°æ®åº“
async function loadDatabases() {
    try {
        console.log('å¼€å§‹åŠ è½½æ•°æ®åº“åˆ—è¡¨ï¼Œå½“å‰è¿æ¥ID:', currentConnectionId, 'æ•°æ®åº“ç±»å‹:', databaseType);
        
        const showDatabasesSQL = databaseType === 'mysql' 
            ? 'SHOW DATABASES' 
            : "SELECT datname FROM pg_database WHERE datistemplate = false ORDER BY datname";
        
        const response = await axios.post('/api/database/execute', {
            connection_id: currentConnectionId,
            sql: showDatabasesSQL
        });
        
        console.log('æ•°æ®åº“åˆ—è¡¨å“åº”:', response.data);
        
        const objectListEl = document.getElementById('objectList');
        if (!objectListEl) {
            console.error('æ— æ³•æ‰¾åˆ° objectList å…ƒç´ ');
            throw new Error('é¡µé¢å…ƒç´ æœªæ‰¾åˆ°');
        }
        
        if (response.data.success && response.data.result) {
            const result = response.data.result;
            
            console.log('åŸå§‹è¿”å›æ•°æ®:', JSON.stringify(result, null, 2));
            
            // æ£€æŸ¥æ˜¯å¦æœ‰rowså­—æ®µ
            if (result.rows && result.rows.length > 0) {
                let html = '';
                result.rows.forEach((row, index) => {
                    console.log(`ç¬¬${index}è¡Œ:`, row, 'ç±»å‹:', typeof row);
                    
                    // è·å–æ•°æ®åº“åç§°
                    let dbName;
                    
                    if (typeof row === 'object' && row !== null && !Array.isArray(row)) {
                        // å¯¹äºå­—å…¸ç±»å‹ï¼Œå–ç¬¬ä¸€ä¸ªé”®çš„å€¼
                        const keys = Object.keys(row);
                        const values = Object.values(row);
                        console.log(`  keys:`, keys, `values:`, values);
                        
                        // æ’é™¤åˆ—åæœ¬èº«
                        if (keys.length > 0 && keys[0] !== values[0]) {
                            dbName = values[0];
                        } else if (keys.length > 1) {
                            dbName = values[1]; // å¦‚æœæœ‰å¤šä¸ªå€¼ï¼Œå–ç¬¬äºŒä¸ª
                        } else {
                            dbName = values[0];
                        }
                    } else if (Array.isArray(row)) {
                        dbName = row[0];
                    } else {
                        dbName = row;
                    }
                    
                    console.log(`è§£æçš„æ•°æ®åº“å:`, dbName);
                    
                    // ç¡®ä¿ dbName æ˜¯å­—ç¬¦ä¸²ä¸”ä¸æ˜¯åˆ—å
                    if (dbName && typeof dbName === 'string' && dbName !== 'Database' && dbName !== 'datname') {
                        html += `
                            <div class="db-tree-node" data-db-name="${dbName}">
                                <div class="db-tree-item" 
                                     onmousedown="event.preventDefault(); toggleDatabase('${dbName}')" 
                                     onmouseover="this.style.background='#f0f0f0'" 
                                     onmouseout="this.style.background='white'">
                                    <span class="db-expand-icon">â–¶</span>
                                    <i class="fas fa-database me-2"></i>${dbName}
                                </div>
                                <div class="db-tree-children" id="db-${dbName}" style="display:none;"></div>
                            </div>
                        `;
                    }
                });
                objectListEl.innerHTML = html;
                
                // æ›´æ–°ä¸»å†…å®¹åŒºåŸŸï¼Œæ˜¾ç¤ºå·²é€‰æ‹©è¿æ¥çš„çŠ¶æ€
                const tabStructure = document.getElementById('tabStructure');
                const tabData = document.getElementById('tabData');
                const tabSql = document.getElementById('tabSql');
                
                if (tabStructure) tabStructure.innerHTML = '<p>è¯·é€‰æ‹©ä¸€ä¸ªæ•°æ®åº“æ¥æŸ¥çœ‹è¡¨ç»“æ„</p>';
                if (tabData) tabData.innerHTML = '<p>è¯·é€‰æ‹©ä¸€ä¸ªæ•°æ®åº“æ¥æŸ¥çœ‹æ•°æ®</p>';
                if (tabSql) {
                    const textarea = tabSql.querySelector('textarea');
                    if (textarea) textarea.value = '';
                }
                
            } else {
                console.warn('æ²¡æœ‰æ•°æ®åº“è¿”å›');
                objectListEl.innerHTML = `
                    <div class="db-empty-state">
                        <div class="db-empty-icon">âš ï¸</div>
                        <div>æœªæ‰¾åˆ°æ•°æ®åº“</div>
                    </div>
                `;
            }
        } else {
            console.error('åŠ è½½æ•°æ®åº“å¤±è´¥:', response.data);
            objectListEl.innerHTML = `
                <div class="db-empty-state">
                    <div class="db-empty-icon">âŒ</div>
                    <div>åŠ è½½å¤±è´¥: ${response.data.message || 'æœªçŸ¥é”™è¯¯'}</div>
                </div>
            `;
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®åº“å¼‚å¸¸:', error);
        
        // å®‰å…¨å¤„ç†é”™è¯¯æ˜¾ç¤º
        const objectListEl = document.getElementById('objectList');
        if (objectListEl) {
            objectListEl.innerHTML = `
                <div class="db-empty-state">
                    <div class="db-empty-icon">âŒ</div>
                    <div>åŠ è½½å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}</div>
                </div>
            `;
        }
        
        throw error;  // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…å¤„ç†
    }
}

// åˆ‡æ¢æ•°æ®åº“å±•å¼€/æŠ˜å 
async function toggleDatabase(dbName) {
    if (!currentConnectionId) return;
    
    const childrenEl = document.getElementById(`db-${dbName}`);
    if (!childrenEl) return;
    
    // å¦‚æœå·²å±•å¼€ï¼Œåˆ™æŠ˜å 
    if (childrenEl.style.display !== 'none') {
        childrenEl.style.display = 'none';
        const icon = document.querySelector(`[data-db-name="${dbName}"] .db-expand-icon`);
        if (icon) icon.textContent = 'â–¶';
        return;
    }
    
    // å±•å¼€å¹¶åŠ è½½è¡¨
    childrenEl.style.display = 'block';
    const icon = document.querySelector(`[data-db-name="${dbName}"] .db-expand-icon`);
    if (icon) icon.textContent = 'â–¼';
    
    // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½è¿‡è¡¨ï¼Œåˆ™åŠ è½½
    if (childrenEl.innerHTML === '') {
        childrenEl.innerHTML = '<div style="padding: 4px 8px; color: #666; font-size: 12px;">åŠ è½½ä¸­...</div>';
        await loadTablesForDb(dbName);
    }
}

// åŠ è½½æŒ‡å®šæ•°æ®åº“çš„è¡¨
async function loadTablesForDb(dbName) {
    if (!currentConnectionId) return;
    
    try {
        console.log(`å¼€å§‹åŠ è½½æ•°æ®åº“ "${dbName}" çš„è¡¨åˆ—è¡¨`);
        
        // å¯¹äº MySQLï¼Œç›´æ¥æŒ‡å®šæ•°æ®åº“å
        const showTablesSQL = databaseType === 'mysql' 
            ? `SHOW TABLES FROM \`${dbName}\``
            : `SELECT table_name FROM information_schema.tables WHERE table_schema = '${dbName}' AND table_type = 'BASE TABLE'`;
        
        console.log('æ‰§è¡Œ SQL:', showTablesSQL);
        
        const response = await axios.post('/api/database/execute', {
            connection_id: currentConnectionId,
            sql: showTablesSQL
        });
        
        console.log('è·å–è¡¨åˆ—è¡¨å“åº”:', response.data);
        
        const childrenEl = document.getElementById(`db-${dbName}`);
        if (!childrenEl) return;
        
        if (response.data.success && response.data.result && response.data.result.rows) {
            console.log('è¡¨æ•°æ®è¡Œæ•°:', response.data.result.rows.length);
            let html = '';
            response.data.result.rows.forEach((row, index) => {
                console.log(`ç¬¬${index}è¡Œè¡¨æ•°æ®:`, row);
                
                let tableName;
                
                if (typeof row === 'object' && row !== null && !Array.isArray(row)) {
                    // è·å–å­—å…¸çš„ç¬¬ä¸€ä¸ªå€¼ï¼ˆå¿½ç•¥é”®åï¼‰
                    const values = Object.values(row);
                    tableName = values[0];
                    console.log('ä»å­—å…¸è·å–è¡¨å:', tableName, 'keys:', Object.keys(row));
                } else if (Array.isArray(row)) {
                    tableName = row[0];
                    console.log('ä»æ•°ç»„è·å–è¡¨å:', tableName);
                } else {
                    tableName = row;
                    console.log('ç›´æ¥ä½¿ç”¨å€¼ä½œä¸ºè¡¨å:', tableName);
                }
                
                console.log(`è§£æçš„è¡¨å:`, tableName);
                
                // æ’é™¤åˆ—åå’Œå…¶ä»–æ— æ•ˆå€¼
                if (tableName && typeof tableName === 'string' && 
                    !tableName.startsWith('Tables_in_') && 
                    tableName !== 'table_name' &&
                    tableName !== 'TABLE_NAME' &&
                    tableName !== 'Table_in_' + dbName) {
                    html += `
                        <div class="db-table-item" 
                             ondblclick="openTable('${dbName}', '${tableName}')"
                             style="padding: 4px 8px 4px 24px; cursor: pointer; border-radius: 4px;"
                             onmouseover="this.style.background='#f0f0f0'" 
                             onmouseout="this.style.background='white'">
                            <i class="fas fa-table me-2"></i>${tableName}
                        </div>
                    `;
                }
            });
            
            if (html) {
                childrenEl.innerHTML = html;
            } else {
                childrenEl.innerHTML = '<div style="padding: 4px 8px; color: #999; font-size: 12px;">æ— è¡¨</div>';
            }
        } else {
            console.error('è·å–è¡¨åˆ—è¡¨å¤±è´¥:', response.data);
            childrenEl.innerHTML = '<div style="padding: 4px 8px; color: #999; font-size: 12px;">æ— è¡¨</div>';
        }
    } catch (error) {
        console.error('åŠ è½½è¡¨å¤±è´¥:', error);
        const childrenEl = document.getElementById(`db-${dbName}`);
        if (childrenEl) {
            let errorMsg = 'åŠ è½½å¤±è´¥: ';
            if (error.response) {
                errorMsg += error.response.data.message || error.response.statusText || 'æœåŠ¡å™¨é”™è¯¯';
            } else if (error.request) {
                errorMsg += 'æ— å“åº”';
            } else {
                errorMsg += error.message;
            }
            childrenEl.innerHTML = `<div style="padding: 4px 8px; color: #f44336; font-size: 12px;">${errorMsg}</div>`;
        }
    }
}

// æ‰“å¼€è¡¨ï¼ˆåŒå‡»ï¼‰
async function openTable(dbName, tableName) {
    if (!currentConnectionId) return;
    
    console.log(`æ‰“å¼€è¡¨: ${dbName}.${tableName}`);
    
    currentDatabase = dbName;
    currentTable = tableName;
    
    // åˆ‡æ¢åˆ°SQLæ ‡ç­¾é¡µå¹¶æ‰§è¡ŒæŸ¥è¯¢
    switchContentTab('sql');
    
    // ç”ŸæˆSQLæŸ¥è¯¢ - ç›´æ¥ä½¿ç”¨æ•°æ®åº“å.è¡¨åçš„æ ¼å¼
    let sql;
    if (databaseType === 'mysql') {
        // MySQLä½¿ç”¨åå¼•å·åŒ…è£¹çš„å®Œæ•´è·¯å¾„
        sql = 'SELECT * FROM `' + dbName + '`.`' + tableName + '` LIMIT 100';
        console.log('ç”Ÿæˆçš„MySQL SQL:', sql);
    } else {
        // PostgreSQLä½¿ç”¨åŒå¼•å·åŒ…è£¹çš„å®Œæ•´è·¯å¾„
        sql = `SELECT * FROM "${dbName}"."${tableName}" LIMIT 100`;
        console.log('ç”Ÿæˆçš„PostgreSQL SQL:', sql);
    }
    
    document.getElementById('sqlEditor').value = sql;
    
    // ç›´æ¥æ‰§è¡ŒSQL
    try {
        await executeSQL();
    } catch (error) {
        console.error('æ‰§è¡ŒSQLå¤±è´¥:', error);
    }
}

// é€‰æ‹©æ•°æ®åº“ï¼ˆæ—§å‡½æ•°ï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
async function selectDatabase(dbName) {
    await toggleDatabase(dbName);
}

// åŠ è½½è¡¨
async function loadTables(dbName) {
    try {
        const showTablesSQL = databaseType === 'mysql' 
            ? 'SHOW TABLES'
            : `SELECT table_name FROM information_schema.tables WHERE table_schema = 'public'`;
        
        const response = await axios.post('/api/database/execute', {
            connection_id: currentConnectionId,
            sql: showTablesSQL
        });
        
        if (response.data.success && response.data.result.rows) {
            let html = '';
            response.data.result.rows.forEach((row) => {
                const tableName = Object.values(row)[0];
                html += `
                    <div style="padding: 8px 12px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;"
                         onclick="openTable('${dbName}', '${tableName}')" 
                         onmouseover="this.style.background='#f0f0f0'" 
                         onmouseout="this.style.background='white'">
                        <span><i class="fas fa-table me-2"></i>${tableName}</span>
                        <span style="color: #999; font-size: 12px;">è¡¨</span>
                    </div>
                `;
            });
            document.getElementById('objectList').innerHTML = html;
        }
    } catch (error) {
        console.error('åŠ è½½è¡¨å¤±è´¥:', error);
    }
}

// åˆ‡æ¢å·¥å…·æ æŒ‰é’®
function showObjects(type) {
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.db-toolbar-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // åŠ è½½å¯¹åº”ç±»å‹çš„å¯¹è±¡
    if (!currentConnectionId) {
        document.getElementById('objectList').innerHTML = `
            <div class="db-empty-state">
                <div class="db-empty-icon">ğŸ“‹</div>
                <div>è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè¿æ¥</div>
            </div>
        `;
        return;
    }
    
    // æ ¹æ®ç±»å‹é‡æ–°åŠ è½½æ•°æ®åº“åˆ—è¡¨
    loadDatabases();
}

// æ‰“å¼€å¯¹è±¡
function openObject() {
    alert('è¯·åœ¨å¯¹è±¡åˆ—è¡¨ä¸­é€‰æ‹©è¦æ‰“å¼€çš„å¯¹è±¡');
}

// è®¾è®¡å¯¹è±¡
function designObject() {
    alert('è®¾è®¡åŠŸèƒ½æš‚æœªå®ç°');
}

// åˆ›å»ºå¯¹è±¡
function createObject() {
    alert('åˆ›å»ºåŠŸèƒ½æš‚æœªå®ç°');
}

// åˆ é™¤å¯¹è±¡
function deleteObject() {
    if (confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„å¯¹è±¡å—ï¼Ÿ')) {
        alert('åˆ é™¤åŠŸèƒ½æš‚æœªå®ç°');
    }
}

// æ˜¾ç¤ºæŸ¥è¯¢ç¼–è¾‘å™¨
function showQueryEditor() {
    switchContentTab('sql');
}

// æ˜¾ç¤ºSQLæ ‡ç­¾
function showSQL() {
    switchContentTab('sql');
}

// åˆ‡æ¢å†…å®¹æ ‡ç­¾
function switchContentTab(tabName) {
    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.db-content-tab').forEach((tab, index) => {
        tab.classList.remove('active');
        if ((tabName === 'objects' && index === 0) || (tabName === 'sql' && index === 1)) {
            tab.classList.add('active');
        }
    });
    
    // éšè—æ‰€æœ‰å†…å®¹
    document.getElementById('tabObjects').style.display = 'none';
    document.getElementById('tabSQL').style.display = 'none';
    
    // æ˜¾ç¤ºå¯¹åº”å†…å®¹
    if (tabName === 'objects') {
        document.getElementById('tabObjects').style.display = 'block';
    } else if (tabName === 'sql') {
        document.getElementById('tabSQL').style.display = 'block';
    }
}

// æ‰§è¡ŒSQL
async function executeSQL() {
    if (!currentConnectionId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¿æ¥');
        return;
    }
    
    const sql = document.getElementById('sqlEditor').value.trim();
    if (!sql) {
        alert('è¯·è¾“å…¥SQLè¯­å¥');
        return;
    }
    
    console.log('å¼€å§‹æ‰§è¡ŒSQL:', sql);
    
    try {
        const response = await axios.post('/api/database/execute', {
            connection_id: currentConnectionId,
            sql: sql
        });
        
        console.log('SQLæ‰§è¡Œå“åº”:', response.data);
        
        if (response.data.success) {
            displaySQLResult(response.data.result);
        } else {
            console.error('SQLæ‰§è¡Œå¤±è´¥:', response.data.message);
            alert('æ‰§è¡Œå¤±è´¥: ' + response.data.message);
        }
    } catch (error) {
        console.error('SQLæ‰§è¡Œå¼‚å¸¸:', error);
        let errorMsg = 'æ‰§è¡Œå¤±è´¥: ';
        if (error.response) {
            // æœåŠ¡å™¨è¿”å›äº†é”™è¯¯å“åº”
            errorMsg += error.response.data.message || error.response.statusText || 'æœåŠ¡å™¨é”™è¯¯';
            console.error('é”™è¯¯è¯¦æƒ…:', error.response.data);
        } else if (error.request) {
            errorMsg += 'æ— å“åº”';
        } else {
            errorMsg += error.message;
        }
        alert(errorMsg);
    }
}

// æ˜¾ç¤ºSQLæ‰§è¡Œç»“æœ
function displaySQLResult(result) {
    // ç¡®ä¿åˆ‡æ¢åˆ°SQLæ ‡ç­¾é¡µ
    switchContentTab('sql');
    
    const area = document.getElementById('sqlResultArea');
    const thead = document.getElementById('sqlResultThead');
    const tbody = document.getElementById('sqlResultTbody');
    
    if (!area || !thead || !tbody) {
        console.error('ç¼ºå°‘å¿…è¦çš„DOMå…ƒç´ ');
        alert('ç¼ºå°‘å¿…è¦çš„æ˜¾ç¤ºå…ƒç´ ');
        return;
    }
    
    // åˆ¤æ–­æ˜¯å¦æœ‰æŸ¥è¯¢ç»“æœ
    if (result.columns && result.rows !== undefined) {
        // æœ‰åˆ—ä¿¡æ¯ï¼Œè¯´æ˜æ˜¯æŸ¥è¯¢è¯­å¥
        
        // æ¸²æŸ“è¡¨å¤´
        let theadHTML = '<tr style="display: table-row;">';
        result.columns.forEach(col => {
            theadHTML += `<th style="display: table-cell; min-width: 250px; width: 250px; background: #fafafa; padding: 14px 16px; border-bottom: 2px solid #e8e8e8; text-align: left; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-sizing: border-box; line-height: 1.8;">${col}</th>`;
        });
        theadHTML += '</tr>';
        thead.innerHTML = theadHTML;
        
        // ä¿å­˜æ‰€æœ‰æ•°æ®è¡Œç”¨äºåˆ†é¡µ
        allRows = result.rows || [];
        currentPage = 1;
        
        // æ¸²æŸ“å½“å‰é¡µçš„æ•°æ®è¡Œ
        renderCurrentPage(result.columns);
        
        // æ˜¾ç¤ºè¡¨æ ¼ - ç¡®ä¿æ ·å¼æ­£ç¡®
        const table = document.getElementById('sqlResultTable');
        if (table) {
            table.style.borderCollapse = 'collapse';
            table.style.background = 'white';
            table.style.display = 'table';
            table.style.width = 'auto';
            table.style.tableLayout = 'auto';
        }
        
        // ç¡®ä¿æ»šåŠ¨å®¹å™¨å¯è§å¹¶å¯ä»¥æ‹–åŠ¨
        const scrollContainer = document.getElementById('sqlResultScrollContainer');
        if (scrollContainer && table) {
            // å¼ºåˆ¶é‡ç½®å¹¶åº”ç”¨æ ·å¼
            scrollContainer.style.cssText = 'overflow: auto !important; max-height: 500px !important; width: 100% !important; position: relative !important; display: block !important;';
            
            table.style.cssText = 'width: auto !important; min-width: 100% !important; table-layout: auto !important; border-collapse: separate !important; display: table !important;';
            
            // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå·²å®Œå…¨æ¸²æŸ“
            setTimeout(() => {
                // è®¡ç®—æ‰€æœ‰åˆ—çš„å®½åº¦æ€»å’Œ
                let totalWidth = 0;
                const containerWidth = scrollContainer.clientWidth;
                const thElements = table.querySelectorAll('th');
                const columnCount = thElements.length;
                
                console.log('==== æ»šåŠ¨è°ƒè¯•ä¿¡æ¯ =====');
                console.log('åˆ—æ•°:', columnCount);
                console.log('å®¹å™¨å®½åº¦:', containerWidth, 'px');
                
                if (columnCount > 0) {
                    // å¼ºåˆ¶è®¾ç½®è¡¨æ ¼å®½åº¦ï¼Œç¡®ä¿æ¨ªå‘æ»šåŠ¨æ¡å§‹ç»ˆå‡ºç°
                    const minColWidth = 250; // å¢åŠ åˆ—å®½
                    totalWidth = Math.max(columnCount * minColWidth, containerWidth + 500); // å¼ºåˆ¶è¶…å‡ºå®¹å™¨å®½åº¦
                    
                    console.log('æ¯åˆ—æœ€å°å®½åº¦:', minColWidth, 'px');
                    console.log('è¡¨æ ¼æœ€å°å®½åº¦:', totalWidth, 'px');
                    console.log('å®¹å™¨å®½åº¦:', containerWidth, 'px');
                    
                    // å¼ºåˆ¶è®¾ç½®è¡¨æ ¼å®½åº¦ï¼Œç¡®ä¿æ»šåŠ¨æ¡å‡ºç°
                    table.style.width = totalWidth + 'px';
                    table.style.minWidth = totalWidth + 'px';
                    table.style.maxWidth = 'none';
                    table.style.tableLayout = 'fixed'; // å›ºå®šå¸ƒå±€ç¡®ä¿å®½åº¦ç”Ÿæ•ˆ
                    
                    console.log('âœ“ å¼ºåˆ¶è®¾ç½®è¡¨æ ¼å®½åº¦:', totalWidth, 'px');
                    console.log('âœ“ è¡¨æ ¼å¸ƒå±€æ¨¡å¼: fixed');
                }
                
                // å»¶è¿Ÿæ£€æŸ¥æ»šåŠ¨æ¡çŠ¶æ€
                setTimeout(() => {
                    const containerScrollWidth = scrollContainer.scrollWidth;
                    console.log('å®¹å™¨scrollWidth:', containerScrollWidth, 'px');
                    console.log('è¶…å‡ºå®½åº¦:', (containerScrollWidth - containerWidth), 'px');
                    
                    if (containerScrollWidth > containerWidth) {
                        console.log('âœ“ æ¨ªå‘æ»šåŠ¨å·²å¯ç”¨ï¼å¯ä»¥æ‹–åŠ¨æŸ¥çœ‹å…¨éƒ¨æ•°æ®');
                    } else {
                        console.log('â„¹ è­¦å‘Šï¼šæ¨ªå‘æ»šåŠ¨æœªè§¦å‘');
                        // æœ€åä¸€æ¬¡å°è¯•ï¼šå¼ºåˆ¶è®©è¡¨æ ¼æ›´å®½
                        table.style.width = (containerWidth + 200) + 'px';
                        console.log('å¼ºåˆ¶è®¾ç½®è¡¨æ ¼å®½åº¦:', (containerWidth + 200), 'px');
                    }
                    console.log('========================');
                    
                    // åˆå§‹åŒ–é¼ æ ‡æ‹–æ‹½å’Œæ»šè½®æ“ä½œ
                    initializeTableScroll();
                }, 100);
            }, 300);
        }
        
        // ç¡®ä¿tbodyä¹Ÿæœ‰æ­£ç¡®çš„displayæ ·å¼
        tbody.style.display = 'table-row-group';
        
        area.style.display = 'block';
        area.style.visibility = 'visible';
        area.style.opacity = '1';
        area.style.marginTop = '16px';
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        const statsEl = document.getElementById('sqlResultStats');
        if (statsEl) {
            if (result.rows && result.rows.length > 0) {
                statsEl.innerHTML = `<span style="color: #1890ff;">âœ“ æ‰§è¡ŒæˆåŠŸ - å…± ${result.row_count || result.rows.length} è¡Œæ•°æ®</span>`;
            } else {
                statsEl.innerHTML = `<span style="color: #52c41a;">âœ“ æ‰§è¡ŒæˆåŠŸ - 0 è¡Œæ•°æ®</span>`;
            }
        }
        
        // æ˜¾ç¤ºæˆ–éšè—åˆ†é¡µæ§ä»¶
        const paginationEl = document.getElementById('sqlResultPagination');
        if (paginationEl) {
            if (allRows && allRows.length > pageSize) {
                paginationEl.style.display = 'flex';
                updatePagination(allRows.length);
            } else {
                paginationEl.style.display = 'none';
            }
        }
    } else {
        // éæŸ¥è¯¢è¯­å¥ï¼ˆå¦‚UPDATE, INSERTç­‰ï¼‰
        area.style.display = 'none';
        const statsEl = document.getElementById('sqlResultStats');
        if (statsEl && result.message) {
            statsEl.innerHTML = `<span style="color: #52c41a;">${result.message}</span>`;
        }
    }
}

// æ¸²æŸ“å½“å‰é¡µæ•°æ®
function renderCurrentPage(columns) {
    const tbody = document.getElementById('sqlResultTbody');
    if (!tbody) return;
    
    let tbodyHTML = '';
    
    if (allRows.length > 0) {
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, allRows.length);
        const currentPageRows = allRows.slice(startIndex, endIndex);
        
        currentPageRows.forEach((row) => {
            tbodyHTML += '<tr style="display: table-row;">';
            columns.forEach(col => {
                const value = row[col];
                const displayValue = (value !== undefined && value !== null) ? String(value) : '';
                tbodyHTML += `<td style="display: table-cell; min-width: 250px; width: 250px; padding: 14px 16px; color: #333; background: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-sizing: border-box; line-height: 1.8;">${displayValue}</td>`;
            });
            tbodyHTML += '</tr>';
        });
    } else {
        // å³ä½¿æ²¡æœ‰æ•°æ®è¡Œï¼Œä¹Ÿè¦åˆ›å»ºä¸€ä¸ªç©ºè¡Œå¹¶æ˜¾ç¤ºæç¤º
        tbodyHTML = '<tr style="display: table-row;"><td colspan="' + columns.length + '" style="display: table-cell; text-align: center; padding: 20px; color: #999;">æŸ¥è¯¢æˆåŠŸï¼Œä½†è¿”å›0è¡Œæ•°æ®</td></tr>';
    }
    
    tbody.innerHTML = tbodyHTML;
    tbody.style.display = 'table-row-group';
}

// åˆå§‹åŒ–é¼ æ ‡æ‹–æ‹½å’Œæ»šè½®æ“ä½œ
function initializeTableScroll() {
    const scrollContainer = document.getElementById('sqlResultScrollContainer');
    if (!scrollContainer) return;
    
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let scrollLeft = 0;
    let scrollTop = 0;
    
    // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
    scrollContainer.addEventListener('mousedown', (e) => {
        isDragging = true;
        scrollContainer.style.cursor = 'grabbing';
        scrollContainer.style.userSelect = 'none';
        
        startX = e.pageX - scrollContainer.offsetLeft;
        startY = e.pageY - scrollContainer.offsetTop;
        scrollLeft = scrollContainer.scrollLeft;
        scrollTop = scrollContainer.scrollTop;
        
        e.preventDefault();
    });
    
    // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
    scrollContainer.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        e.preventDefault();
        const x = e.pageX - scrollContainer.offsetLeft;
        const y = e.pageY - scrollContainer.offsetTop;
        
        const walkX = (x - startX) * 2;
        const walkY = (y - startY) * 2;
        
        scrollContainer.scrollLeft = scrollLeft - walkX;
        scrollContainer.scrollTop = scrollTop - walkY;
    });
    
    // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
    scrollContainer.addEventListener('mouseup', () => {
        isDragging = false;
        scrollContainer.style.cursor = 'grab';
        scrollContainer.style.userSelect = '';
    });
    
    // é¼ æ ‡ç¦»å¼€å®¹å™¨æ—¶é‡Šæ”¾
    scrollContainer.addEventListener('mouseleave', () => {
        isDragging = false;
        scrollContainer.style.cursor = 'grab';
        scrollContainer.style.userSelect = '';
    });
    
    // æ‚¬åœæ—¶æ˜¾ç¤ºæŠ“å–å…‰æ ‡
    scrollContainer.addEventListener('mouseenter', () => {
        scrollContainer.style.cursor = 'grab';
    });
    
    // æ»šè½®äº‹ä»¶ - æ¨ªå‘æ»šåŠ¨
    scrollContainer.addEventListener('wheel', (e) => {
        if (e.shiftKey || (e.deltaX !== 0)) {
            e.preventDefault();
            scrollContainer.scrollLeft += e.deltaY || e.deltaX;
        }
    }, { passive: false });
    
    console.log('âœ“ é¼ æ ‡æ‹–æ‹½å’Œæ»šè½®æ“ä½œå·²åˆå§‹åŒ–');
}

// æ›´æ–°åˆ†é¡µæ§ä»¶
function updatePagination(totalRows) {
    const totalPages = Math.ceil(totalRows / pageSize);
    const infoEl = document.getElementById('paginationInfo');
    const buttonsEl = document.getElementById('paginationButtons');
    
    if (!infoEl || !buttonsEl) return;
    
    // æ›´æ–°ä¿¡æ¯
    const startRow = (currentPage - 1) * pageSize + 1;
    const endRow = Math.min(currentPage * pageSize, totalRows);
    infoEl.innerHTML = `æ˜¾ç¤ºç¬¬ ${startRow}-${endRow} è¡Œï¼Œå…± ${totalRows} è¡Œï¼ˆç¬¬ ${currentPage}/${totalPages} é¡µï¼‰`;
    
    // æ›´æ–°æŒ‰é’®
    let buttonsHTML = '';
    
    // é¦–é¡µ
    buttonsHTML += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(1)">
        <i class="fas fa-angle-double-left"></i>
    </button>`;
    
    // ä¸Šä¸€é¡µ
    buttonsHTML += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
        <i class="fas fa-angle-left"></i>
    </button>`;
    
    // é¡µç æŒ‰é’®ï¼ˆæ˜¾ç¤ºå½“å‰é¡µå‰å2é¡µï¼‰
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        buttonsHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }
    
    // ä¸‹ä¸€é¡µ
    buttonsHTML += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
        <i class="fas fa-angle-right"></i>
    </button>`;
    
    // æœ«é¡µ
    buttonsHTML += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${totalPages})">
        <i class="fas fa-angle-double-right"></i>
    </button>`;
    
    buttonsEl.innerHTML = buttonsHTML;
}

// è·³è½¬åˆ°æŒ‡å®šé¡µ
function goToPage(page) {
    const thead = document.getElementById('sqlResultThead');
    if (!thead || allRows.length === 0) return;
    
    const totalPages = Math.ceil(allRows.length / pageSize);
    
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    
    // è·å–åˆ—å
    const columns = Array.from(thead.querySelectorAll('th')).map(th => th.textContent);
    
    // é‡æ–°æ¸²æŸ“å½“å‰é¡µ
    renderCurrentPage(columns);
    
    // æ›´æ–°åˆ†é¡µæ§ä»¶
    updatePagination(allRows.length);
    
    // æ»šåŠ¨åˆ°è¡¨æ ¼é¡¶éƒ¨
    const scrollContainer = document.getElementById('sqlResultScrollContainer');
    if (scrollContainer) {
        scrollContainer.scrollTop = 0;
        scrollContainer.scrollLeft = 0;
    }
}

// æ¸…ç©ºSQL
function clearSQL() {
    document.getElementById('sqlEditor').value = '';
    document.getElementById('sqlResultArea').style.display = 'none';
    allRows = [];
    currentPage = 1;
}

// åŠ è½½ä¿å­˜çš„è¿æ¥
async function loadSavedConnections() {
    try {
        console.log('å¼€å§‹åŠ è½½ä¿å­˜çš„è¿æ¥');
        const response = await axios.get('/api/database/saved');
        console.log('æœåŠ¡å™¨å“åº”:', response.data);
        
        if (response.data.success && response.data.connections) {
            const savedConns = response.data.connections;
            console.log('æ‰¾åˆ°ä¿å­˜çš„è¿æ¥æ•°é‡:', savedConns.length);
            connections = []; // æ¸…ç©ºç°æœ‰è¿æ¥
            savedConns.forEach(conn => {
                connections.push({
                    id: conn.id,
                    name: conn.name,
                    type: conn.type,
                    host: conn.host,
                    port: conn.port,
                    username: conn.username,
                    database: conn.database
                });
            });
            console.log('å·²åŠ è½½è¿æ¥:', connections);
            updateConnectionList();
        } else {
            console.log('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„è¿æ¥');
            connections = [];
            updateConnectionList();
        }
    } catch (error) {
        console.error('åŠ è½½ä¿å­˜çš„è¿æ¥å¤±è´¥:', error);
        connections = [];
        updateConnectionList();
    }
}

// åˆ é™¤è¿æ¥
async function deleteConnection(connectionId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è¿æ¥å—ï¼Ÿ')) {
        return;
    }
    
    console.log('å¼€å§‹åˆ é™¤è¿æ¥:', connectionId);
    
    try {
        const response = await axios.post('/api/database/delete', {
            connection_id: connectionId
        });
        
        console.log('åˆ é™¤å“åº”:', response.data);
        
        if (response.data.success) {
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰è¿æ¥ï¼Œæ¸…ç©ºå½“å‰çŠ¶æ€
            if (currentConnectionId === connectionId) {
                currentConnectionId = null;
                currentConnection = null;
                document.getElementById('objectList').innerHTML = `
                    <div class="db-empty-state">
                        <div class="db-empty-icon">ğŸ“¡</div>
                        <div>è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè¿æ¥</div>
                    </div>
                `;
            }
            
            // é‡æ–°ä»æœåŠ¡å™¨åŠ è½½è¿æ¥åˆ—è¡¨
            await loadSavedConnections();
            
            alert('åˆ é™¤æˆåŠŸ');
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + response.data.message);
        }
    } catch (error) {
        console.error('åˆ é™¤è¿æ¥å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
}

// é‡æ–°è¿æ¥ï¼ˆéœ€è¦å¯†ç ï¼‰
async function reconnectDatabase(connectionId) {
    const password = prompt('è¯·è¾“å…¥å¯†ç ï¼š');
    if (!password) return;
    
    try {
        const response = await axios.post('/api/database/reconnect', {
            connection_id: connectionId,
            password: password
        });
        
        if (response.data.success) {
            currentConnectionId = response.data.connection_id;
            const conn = connections.find(c => c.id === connectionId);
            if (conn) {
                currentConnection = conn;
                databaseType = conn.type;
                await loadDatabases();
            }
            alert('é‡æ–°è¿æ¥æˆåŠŸï¼');
        } else {
            alert('é‡æ–°è¿æ¥å¤±è´¥: ' + response.data.message);
        }
    } catch (error) {
        alert('é‡æ–°è¿æ¥å¤±è´¥: ' + error.message);
    }
}

// ä¿®æ”¹ selectConnection å‡½æ•°ä»¥æ”¯æŒé‡æ–°è¿æ¥
async function selectConnection(connectionId) {
    const conn = connections.find(c => c.id === connectionId);
    if (!conn) {
        console.error('æœªæ‰¾åˆ°è¿æ¥:', connectionId);
        return;
    }
    
    console.log('é€‰æ‹©è¿æ¥:', conn);
    
    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.db-connection-item').forEach(item => {
        item.classList.remove('active');
    });
    document.getElementById(`conn-${connectionId}`)?.classList.add('active');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼‰
    const objectListEl = document.getElementById('objectList');
    if (objectListEl) {
        objectListEl.innerHTML = `
            <div class="db-empty-state">
                <div class="db-empty-icon">â³</div>
                <div>æ­£åœ¨è¿æ¥...</div>
            </div>
        `;
    }
    
    // æ£€æŸ¥è¿æ¥æ˜¯å¦å·²å»ºç«‹ï¼ˆé€šè¿‡å°è¯•æ‰§è¡ŒSQLï¼‰
    try {
        currentConnectionId = connectionId;
        currentConnection = conn;
        databaseType = conn.type;
        
        console.log('è®¾ç½®å½“å‰è¿æ¥ä¿¡æ¯:', { currentConnectionId, databaseType });
        
        // å°è¯•åŠ è½½æ•°æ®åº“åˆ—è¡¨
        await loadDatabases();
    } catch (error) {
        // è¿æ¥å·²æ–­å¼€ï¼Œéœ€è¦é‡æ–°è¾“å…¥å¯†ç 
        console.log('è¿æ¥å·²æ–­å¼€ï¼Œéœ€è¦é‡æ–°è¿æ¥ï¼Œé”™è¯¯:', error);
        
        // å®‰å…¨æ›´æ–°DOM
        const objectListEl = document.getElementById('objectList');
        if (objectListEl) {
            objectListEl.innerHTML = `
                <div class="db-empty-state">
                    <div class="db-empty-icon">ğŸ”‘</div>
                    <div>éœ€è¦é‡æ–°è¾“å…¥å¯†ç </div>
                </div>
            `;
        }
        
        const password = prompt(`è¯·è¾“å…¥ ${conn.name} çš„å¯†ç ï¼š`);
        if (!password) {
            if (objectListEl) {
                objectListEl.innerHTML = `
                    <div class="db-empty-state">
                        <div class="db-empty-icon">âŒ</div>
                        <div>å·²å–æ¶ˆ</div>
                    </div>
                `;
            }
            return;
        }
        
        try {
            const response = await axios.post('/api/database/reconnect', {
                connection_id: connectionId,
                password: password
            });
            
            if (response.data.success) {
                // æ›´æ–°connectionIdä¸ºæ–°çš„ID
                currentConnectionId = response.data.connection_id;
                // æ›´æ–°è¿æ¥åˆ—è¡¨ä¸­çš„ID
                conn.id = response.data.connection_id;
                // ä¿å­˜åˆ°connectionsæ•°ç»„
                const index = connections.findIndex(c => c.id === connectionId);
                if (index !== -1) {
                    connections[index] = {...conn, id: response.data.connection_id};
                }
                
                currentConnection = conn;
                databaseType = conn.type;
                
                console.log('é‡æ–°è¿æ¥æˆåŠŸï¼Œæ–°ID:', response.data.connection_id);
                
                // é‡æ–°åŠ è½½æ•°æ®åº“åˆ—è¡¨
                await loadDatabases();
                
                // æ›´æ–°DOMä¸­çš„ID
                const elem = document.getElementById(`conn-${connectionId}`);
                if (elem) {
                    elem.id = `conn-${response.data.connection_id}`;
                    elem.onclick = () => selectConnection(response.data.connection_id);
                }
            } else {
                alert('é‡æ–°è¿æ¥å¤±è´¥: ' + response.data.message);
            }
        } catch (err) {
            console.error('é‡æ–°è¿æ¥å¼‚å¸¸:', err);
            const errorMsg = err.response?.data?.message || err.message || 'æœªçŸ¥é”™è¯¯';
            alert('é‡æ–°è¿æ¥å¤±è´¥: ' + errorMsg);
        }
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // è®¾ç½®é»˜è®¤ç«¯å£
    document.getElementById('dbType').addEventListener('change', function() {
        const portInput = document.getElementById('dbPort');
        portInput.value = this.value === 'mysql' ? '3306' : '5432';
    });
    
    // åˆå§‹åŒ–è¡¨æ ¼åˆ—å®½è°ƒæ•´åŠŸèƒ½
    initializeColumnResize();
    
    // åŠ è½½ä¿å­˜çš„è¿æ¥
    loadSavedConnections();
});

// åˆå§‹åŒ–åˆ—å®½è°ƒæ•´åŠŸèƒ½
function initializeColumnResize() {
    let isResizing = false;
    let currentHeader = null;
    let startX = 0;
    let startWidth = 0;
    
    document.addEventListener('mousedown', (e) => {
        const header = e.target.closest('th');
        if (!header) return;
        
        const headerRight = header.getBoundingClientRect().right;
        const clickX = e.clientX;
        
        // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨è¡¨å¤´çš„å³ä¾§10pxèŒƒå›´å†…
        if (clickX >= headerRight - 10 && clickX <= headerRight + 2) {
            isResizing = true;
            currentHeader = header;
            startX = clickX;
            startWidth = header.offsetWidth;
            header.style.cursor = 'col-resize';
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        }
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isResizing || !currentHeader) return;
        
        const diff = e.clientX - startX;
        const newWidth = Math.max(120, startWidth + diff);
        currentHeader.style.width = newWidth + 'px';
        currentHeader.style.minWidth = newWidth + 'px';
        
        // åŒæ­¥åŒä¸€åˆ—çš„æ‰€æœ‰å•å…ƒæ ¼å®½åº¦
        const index = Array.from(currentHeader.parentElement.children).indexOf(currentHeader);
        const table = currentHeader.closest('table');
        if (table) {
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cell = row.children[index];
                if (cell) {
                    cell.style.width = newWidth + 'px';
                    cell.style.minWidth = newWidth + 'px';
                }
            });
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            if (currentHeader) {
                currentHeader.style.cursor = '';
            }
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            currentHeader = null;
        }
    });
}
</script>
{% endblock %}
