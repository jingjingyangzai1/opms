{% extends "base.html" %}

{% block title %}主控物理服务器 - 运维管理系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 侧边栏 -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky pt-3">
                <div class="text-center mb-4">
                    <div style="font-size: 32px; color: #00d4ff; margin-bottom: 8px;">
                        <i class="fas fa-database"></i>
                    </div>
                    <h5 class="text-white">运维管理系统</h5>
                </div>
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('training_assets') }}">
                            <i class="fas fa-database me-2"></i>训练系统资产
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('physical_servers') }}">
                            <i class="fas fa-server me-2"></i>主控物理服务器
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('database_manager') }}">
                            <i class="fas fa-code me-2"></i>数据库管理
                        </a>
                    </li>
                </ul>
                
                <!-- 用户管理区域 -->
                <div class="mt-4 pt-3" style="border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <h6 class="text-white-50 mb-3">用户管理</h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('users') }}">
                                <i class="fas fa-users me-2"></i>用户管理
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- 主内容区 -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <!-- 顶部导航 -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom" style="border-color: rgba(0, 212, 255, 0.3) !important;">
                <h1 class="h2 text-white">
                    <i class="fas fa-server me-2" style="color: #00d4ff;"></i>主控物理服务器管理
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button class="btn tech-btn" data-bs-toggle="modal" data-bs-target="#addAssetModal">
                            <i class="fas fa-plus me-1"></i>添加服务器
                        </button>
                        <span class="text-white me-3 ms-3">欢迎, {{ current_user.name }}</span>
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                            <i class="fas fa-sign-out-alt me-1"></i>退出
                        </a>
                    </div>
                </div>
            </div>

             <!-- 统计卡片 -->
             <div class="row mb-4">
                 <div class="col-md-6">
                     <div class="tech-card p-3 text-center" style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3);">
                         <i class="fas fa-server fa-2x mb-2" style="color: #00d4ff;"></i>
                         <h5 class="text-white mb-1" id="totalServers">0</h5>
                         <small class="text-white-50">总服务器数</small>
                     </div>
                 </div>
                 <div class="col-md-6">
                     <div class="tech-card p-3 text-center" style="background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3);">
                         <i class="fas fa-check-circle fa-2x mb-2" style="color: #52c41a;"></i>
                         <h5 class="text-white mb-1" id="onlineServers">0</h5>
                         <small class="text-white-50">在线服务器</small>
                     </div>
                 </div>
             </div>

            <!-- 服务器列表 -->
            <div class="main-content">
                <div class="table-responsive" style="width: 100%; max-width: none; overflow-x: auto; padding-bottom: 80px; margin-bottom: 10px;">
                    <table class="table table-dark table-hover" style="width: 100%; min-width: 1600px;">
                         <thead>
                             <tr>
                                 <th style="min-width: 180px;"><i class="fas fa-tag me-1"></i>服务器名称</th>
                                 <th style="min-width: 120px;"><i class="fas fa-cog me-1"></i>类型</th>
                                 <th style="min-width: 100px;"><i class="fas fa-circle me-1"></i>状态</th>
                                 <th style="min-width: 140px;"><i class="fas fa-network-wired me-1"></i>IP地址</th>
                                 <th style="min-width: 80px;"><i class="fas fa-plug me-1"></i>端口</th>
                                 <th style="min-width: 180px;"><i class="fas fa-clock me-1"></i>最后更新</th>
                                 <th style="min-width: 400px;"><i class="fas fa-tools me-1"></i>操作</th>
                             </tr>
                         </thead>
                        <tbody id="serversTableBody">
                            <!-- 服务器数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控件 -->
                <div class="pagination-container" style="margin-top: 20px; padding: 12px 16px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="pagination-info" style="color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                            <span id="paginationInfo">显示第 0-0 行,共 0 行 (第 0/0 页)</span>
                        </div>
                        <div class="pagination-buttons" id="serversPagination">
                            <!-- 分页按钮将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- 添加服务器模态框 -->
<div class="modal fade" id="addAssetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: rgba(0, 0, 0, 0.9); border: 1px solid rgba(0, 212, 255, 0.3);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0, 212, 255, 0.3);">
                <h5 class="modal-title text-white">
                    <i class="fas fa-plus me-2" style="color: #00d4ff;"></i>添加服务器
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAssetForm">
                    <div class="mb-3">
                        <label for="assetName" class="form-label text-white">服务器名称</label>
                        <input type="text" class="form-control tech-input" id="assetName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="assetType" class="form-label text-white">服务器类型</label>
                        <select class="form-select tech-input" id="assetType" name="type" required>
                            <option value="物理资产">物理资产</option>
                            <option value="虚拟资产">虚拟资产</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="assetIp" class="form-label text-white">IP地址</label>
                        <input type="text" class="form-control tech-input" id="assetIp" name="ip" required>
                    </div>
                    <div class="mb-3">
                        <label for="assetPort" class="form-label text-white">端口</label>
                        <input type="number" class="form-control tech-input" id="assetPort" name="port" value="22" required>
                    </div>
                    <div class="mb-3">
                        <label for="assetUsername" class="form-label text-white">账户</label>
                        <input type="text" class="form-control tech-input" id="assetUsername" name="username" placeholder="请输入账户名" value="">
                    </div>
                    <div class="mb-3">
                        <label for="assetPassword" class="form-label text-white">密码</label>
                        <input type="password" class="form-control tech-input" id="assetPassword" name="password" placeholder="请输入密码" value="">
                    </div>
                    <div class="mb-3">
                        <label for="assetDescription" class="form-label text-white">描述</label>
                        <textarea class="form-control tech-input" id="assetDescription" name="description" rows="1" style="height: 38px; resize: none;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(0, 212, 255, 0.3);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn tech-btn" onclick="addAsset()">
                    <i class="fas fa-save me-1"></i>保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑服务器模态框 -->
<div class="modal fade" id="editAssetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: rgba(0, 0, 0, 0.9); border: 1px solid rgba(0, 212, 255, 0.3);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0, 212, 255, 0.3);">
                <h5 class="modal-title text-white">
                    <i class="fas fa-edit me-2" style="color: #00d4ff;"></i>编辑服务器
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAssetForm">
                    <input type="hidden" id="editAssetId" name="id">
                    <div class="mb-3">
                        <label for="editAssetName" class="form-label text-white">服务器名称</label>
                        <input type="text" class="form-control tech-input" id="editAssetName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAssetType" class="form-label text-white">服务器类型</label>
                        <select class="form-select tech-input" id="editAssetType" name="type" required>
                                    <option value="物理资产">物理资产</option>
                                    <option value="虚拟资产">虚拟资产</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editAssetIp" class="form-label text-white">IP地址</label>
                        <input type="text" class="form-control tech-input" id="editAssetIp" name="ip" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAssetPort" class="form-label text-white">端口</label>
                        <input type="number" class="form-control tech-input" id="editAssetPort" name="port" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAssetUsername" class="form-label text-white">账户</label>
                        <input type="text" class="form-control tech-input" id="editAssetUsername" name="username" placeholder="请输入账户名">
                    </div>
                    <div class="mb-3">
                        <label for="editAssetPassword" class="form-label text-white">密码</label>
                        <input type="password" class="form-control tech-input" id="editAssetPassword" name="password" placeholder="请输入密码">
                    </div>
                    <div class="mb-3">
                        <label for="editAssetDescription" class="form-label text-white">描述</label>
                        <textarea class="form-control tech-input" id="editAssetDescription" name="description" rows="1" style="height: 38px; resize: none;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(0, 212, 255, 0.3);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn tech-btn" onclick="updateAsset()">
                    <i class="fas fa-save me-1"></i>更新
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentServers = [];
let currentPage = 1;
let itemsPerPage = 50; // 每页50条，与图片示例一致

// 切换更多操作菜单显示/隐藏（简化版本，更可靠）
function toggleMoreActions(assetId) {
    // 关闭所有其他菜单
    document.querySelectorAll('.more-actions-menu').forEach(function(menu) {
        if (menu.id !== `more-actions-${assetId}`) {
            menu.style.display = 'none';
        }
    });
    
    // 切换当前菜单
    const menu = document.getElementById(`more-actions-${assetId}`);
    if (menu) {
        if (menu.style.display === 'none' || !menu.style.display) {
            menu.style.display = 'block';
        } else {
            menu.style.display = 'none';
        }
    }
}

// 关闭更多操作菜单
function closeMoreActions(assetId) {
    const menu = document.getElementById(`more-actions-${assetId}`);
    if (menu) {
        menu.style.display = 'none';
    }
}

// 关闭所有更多操作菜单
function closeAllMoreActions() {
    document.querySelectorAll('.more-actions-menu').forEach(function(menu) {
        menu.style.display = 'none';
    });
}

// 确认并删除服务器
function confirmAndDeleteAsset(assetId) {
    if (confirm('⚠️ 警告：确定要删除这个服务器吗？\n\n此操作不可恢复，请谨慎操作！')) {
        deleteAsset(assetId);
    }
}

// 旧的dropdown函数（保留但不再使用）
let currentDropdown = null;

function toggleDropdown(assetId, event) {
    try {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
        }
        
        const menu = document.getElementById(`dropdown-${assetId}`);
        if (!menu) {
            console.error('下拉菜单元素不存在:', assetId);
            return false;
        }
        
        // 如果当前菜单已经打开，则关闭它
        if (currentDropdown === assetId) {
            closeDropdown(assetId);
            return false;
        }
        
        // 关闭其他所有下拉菜单
        closeAllDropdowns();
        
        // 显示当前菜单
        showDropdown(assetId);
        return false;
    } catch (error) {
        console.error('切换下拉菜单出错:', error);
        return false;
    }
}

// 显示下拉菜单
function showDropdown(assetId) {
    console.log('showDropdown called with assetId:', assetId);
    const menu = document.getElementById(`dropdown-${assetId}`);
    if (!menu) {
        console.error('Menu not found in showDropdown for assetId:', assetId);
        return;
    }
    
    // 通过ID直接查找对应的按钮
    const button = document.getElementById(`dropdown-btn-${assetId}`);
    if (!button) {
        console.error('Button not found for menu:', menu);
        return;
    }
    
    console.log('Button found:', button);
    const buttonRect = button.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    console.log('Button rect:', buttonRect);
    console.log('Viewport size:', viewportWidth, 'x', viewportHeight);
    
    // 菜单尺寸
    const menuWidth = 130;
    const menuHeight = 90;
    const padding = 15;
    
    // 计算位置 - 简化逻辑
    let left = buttonRect.right - menuWidth; // 默认右对齐
    let top = buttonRect.bottom + 8; // 默认向下显示
    
    // 水平边界检查
    if (left < padding) {
        left = buttonRect.left; // 改为左对齐
    }
    if (left + menuWidth > viewportWidth - padding) {
        left = viewportWidth - menuWidth - padding; // 强制右边界
    }
    
    // 垂直边界检查
    if (top + menuHeight > viewportHeight - padding) {
        top = buttonRect.top - menuHeight - 8; // 改为向上显示
    }
    if (top < padding) {
        top = padding; // 强制上边界
    }
    
    console.log('Calculated position:', left, top);
    
    // 应用样式
    menu.style.position = 'fixed';
    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
    menu.style.zIndex = '10000';
    menu.style.width = menuWidth + 'px';
    menu.style.height = menuHeight + 'px';
    menu.style.display = 'block';
    menu.style.visibility = 'visible';
    menu.style.opacity = '0';
    menu.style.transform = 'scale(0.9)';
    menu.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
    menu.style.pointerEvents = 'auto';
    
    console.log('Menu styles applied, triggering animation');
    
    // 触发动画
    requestAnimationFrame(() => {
        menu.style.opacity = '1';
        menu.style.transform = 'scale(1)';
        console.log('Animation triggered');
    });
    
    // 标记为当前打开的下拉菜单
    currentDropdown = assetId;
    console.log('Current dropdown set to:', currentDropdown);
}

// 关闭指定下拉菜单
function closeDropdown(assetId) {
    const menu = document.getElementById(`dropdown-${assetId}`);
    if (menu) {
        menu.style.opacity = '0';
        menu.style.transform = 'scale(0.9)';
        menu.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
        
        // 延迟隐藏
        setTimeout(() => {
            menu.style.display = 'none';
            menu.style.visibility = 'hidden';
        }, 150);
    }
    
    if (currentDropdown === assetId) {
        currentDropdown = null;
    }
}

// 关闭所有下拉菜单
function closeAllDropdowns() {
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        if (menu.style.display !== 'none') {
            menu.style.opacity = '0';
            menu.style.transform = 'scale(0.9)';
            menu.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
            
            setTimeout(() => {
                menu.style.display = 'none';
                menu.style.visibility = 'hidden';
            }, 150);
        }
    });
    currentDropdown = null;
}

// 初始化更多操作菜单事件监听器（简化版本）
function initMoreActionsListeners() {
    // 点击页面其他地方时关闭所有菜单
    if (!window._moreActionsClickHandler) {
        window._moreActionsClickHandler = function(e) {
            // 如果点击的不是更多操作按钮或菜单项，则关闭所有菜单
            if (!e.target.closest('.more-actions-menu') && !e.target.closest('[onclick*="toggleMoreActions"]')) {
                closeAllMoreActions();
            }
        };
        document.addEventListener('click', window._moreActionsClickHandler, true);
    }
    
    // ESC键关闭菜单
    if (!window._moreActionsKeyHandler) {
        window._moreActionsKeyHandler = function(e) {
            if (e.key === 'Escape') {
                closeAllMoreActions();
            }
        };
        document.addEventListener('keydown', window._moreActionsKeyHandler);
    }
    
    // 窗口大小改变或滚动时关闭菜单
    window.addEventListener('resize', closeAllMoreActions);
    window.addEventListener('scroll', closeAllMoreActions, true);
}

// 旧的初始化函数（保留但不再使用）
function initDropdownListeners() {
    // 移除旧的事件监听器（如果存在）
    if (window._dropdownClickHandler) {
        document.removeEventListener('click', window._dropdownClickHandler, true);
    }
    if (window._dropdownTableHandler) {
        const tbody = document.getElementById('serversTableBody');
        if (tbody) {
            tbody.removeEventListener('click', window._dropdownTableHandler);
        }
    }
    
    // 方式1：直接绑定到每个按钮（最可靠）
    document.querySelectorAll('.dropdown-toggle[data-asset-id]').forEach(function(btn) {
        // 移除旧的事件监听器
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        // 添加新的事件监听器
        newBtn.addEventListener('click', function(e) {
            console.log('按钮直接点击事件触发');
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            const assetId = this.getAttribute('data-asset-id') || this.id.replace('dropdown-btn-', '');
            if (assetId) {
                console.log('触发下拉菜单，assetId:', assetId);
                toggleDropdown(assetId, e);
            }
        }, true);
        
        // 也绑定mousedown作为备用
        newBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            const assetId = this.getAttribute('data-asset-id') || this.id.replace('dropdown-btn-', '');
            if (assetId) {
                toggleDropdown(assetId, e);
            }
        }, true);
    });
    
    // 方式2：使用事件委托在表格上监听点击（备用方案）
    const tbody = document.getElementById('serversTableBody');
    if (tbody) {
        window._dropdownTableHandler = function(e) {
            const target = e.target;
            
            // 检查是否点击了下拉按钮或其子元素
            const dropdownBtn = target.closest('.dropdown-toggle');
            if (dropdownBtn) {
                console.log('事件委托捕获到下拉按钮点击');
                e.preventDefault();
                e.stopPropagation();
                const assetId = dropdownBtn.getAttribute('data-asset-id') || dropdownBtn.id.replace('dropdown-btn-', '');
                if (assetId) {
                    toggleDropdown(assetId, e);
                }
                return;
            }
            
            // 检查是否点击了菜单项
            const dropdownItem = target.closest('.dropdown-item');
            if (dropdownItem) {
                e.preventDefault();
                e.stopPropagation();
                return;
            }
        };
        tbody.addEventListener('click', window._dropdownTableHandler, true);
    }
    
    // 创建全局点击处理函数
    window._dropdownClickHandler = function(e) {
        const dropdown = e.target.closest('.dropdown');
        const dropdownMenu = e.target.closest('.dropdown-menu');
        const dropdownButton = e.target.closest('.dropdown-toggle');
        const dropdownItem = e.target.closest('.dropdown-item');
        
        // 如果点击的是下拉相关元素，不关闭
        if (dropdown || dropdownMenu || dropdownButton || dropdownItem) {
            return;
        }
        
        // 否则关闭所有下拉菜单
        closeAllDropdowns();
    };
    
    // 使用捕获阶段，确保优先处理
    document.addEventListener('click', window._dropdownClickHandler, true);
    
    // 窗口大小改变时关闭所有下拉菜单
    window.addEventListener('resize', function() {
        closeAllDropdowns();
    });
    
    // 滚动时关闭所有下拉菜单
    window.addEventListener('scroll', function() {
        closeAllDropdowns();
    }, true);
    
    // ESC键关闭下拉菜单
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllDropdowns();
        }
    });
}

// 页面加载时获取服务器数据
document.addEventListener('DOMContentLoaded', function() {
    loadServers();
    initMoreActionsListeners();
});

// 页面完全加载后初始化
window.addEventListener('load', function() {
    initMoreActionsListeners();
});

// 加载服务器数据
async function loadServers() {
    try {
        const response = await axios.get('/api/assets?category=physical');
        currentServers = response.data;
        currentPage = 1; // 重置到第一页
        updateServersTable();
        updateStatistics();
    } catch (error) {
        console.error('加载服务器数据失败:', error);
        showAlert('加载服务器数据失败！', 'danger');
    }
}

// 更新服务器表格（带分页）
function updateServersTable() {
    const tbody = document.getElementById('serversTableBody');
    tbody.innerHTML = '';
    
    // 计算分页
    const totalItems = currentServers.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
    const paginatedServers = currentServers.slice(startIndex, endIndex);
    
    // 如果当前页超出范围，跳转到最后一页
    if (currentPage > totalPages) {
        currentPage = totalPages;
        updateServersTable();
        return;
    }
    
    // 渲染当前页的数据
    paginatedServers.forEach(server => {
        const row = document.createElement('tr');
         row.innerHTML = `
             <td>
                 <i class="fas fa-server me-2" style="color: #00d4ff;"></i>
                 <span class="text-white">${server.name}</span>
             </td>
             <td><span class="badge bg-primary">${server.type}</span></td>
             <td>${getStatusBadge(server.status)}</td>
             <td><span class="text-info font-monospace">${server.ip}</span></td>
             <td><span class="text-white-50">${server.port}</span></td>
             <td><span class="text-white-50">${server.last_update}</span></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-success" onclick="restartAsset(${server.id})" title="重启">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button class="btn btn-warning" onclick="shutdownAsset(${server.id})" title="关机">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button class="btn btn-info" onclick="openTerminal(${server.id})" title="SSH终端">
                                <i class="fas fa-terminal"></i>
                            </button>
                            <button class="btn btn-primary" onclick="openFileManager(${server.id})" title="文件管理">
                                <i class="fas fa-file"></i>
                            </button>
                            <div class="btn-group" style="position: relative;">
                                <button type="button" 
                                        class="btn btn-secondary" 
                                        onclick="toggleMoreActions('${server.id}')"
                                        title="更多操作"
                                        style="position: relative; z-index: 1001; cursor: pointer;">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div id="more-actions-${server.id}" 
                                     class="more-actions-menu" 
                                     style="display: none; position: absolute; right: 0; top: 100%; z-index: 10000; margin-top: 5px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); min-width: 120px;">
                                    <a href="javascript:void(0)" 
                                       class="more-actions-item" 
                                       onclick="editAsset(${server.id}); closeMoreActions('${server.id}');">
                                        <i class="fas fa-edit me-2"></i>编辑
                                    </a>
                                    <a href="javascript:void(0)" 
                                       class="more-actions-item more-actions-item-danger" 
                                       onclick="confirmAndDeleteAsset(${server.id}); closeMoreActions('${server.id}');">
                                        <i class="fas fa-trash me-2"></i>删除
                                    </a>
                                </div>
                            </div>
                        </div>
                    </td>
         `;
        tbody.appendChild(row);
    });
    
    // 更新分页控件
    updatePagination(totalItems, totalPages, startIndex, endIndex);
    
    // 表格更新后，确保更多操作菜单功能正常
    setTimeout(function() {
        initMoreActionsListeners();
    }, 50);
}

// 更新分页控件（按图片样式）
function updatePagination(totalItems, totalPages, startIndex, endIndex) {
    const paginationEl = document.getElementById('serversPagination');
    const infoEl = document.getElementById('paginationInfo');
    
    if (!paginationEl || !infoEl) return;
    
    // 更新信息显示（格式：显示第 1-50 行,共 100 行 (第 1/2 页)）
    if (totalItems > 0) {
        const startRow = startIndex + 1;
        const endRow = endIndex;
        infoEl.textContent = `显示第 ${startRow}-${endRow} 行,共 ${totalItems} 行 (第 ${currentPage}/${totalPages} 页)`;
    } else {
        infoEl.textContent = '显示第 0-0 行,共 0 行 (第 0/0 页)';
    }
    
    // 生成分页按钮
    paginationEl.innerHTML = '';
    
    if (totalPages <= 1) {
        return; // 只有一页或没有数据时不显示分页
    }
    
    // 首页按钮（«）- 在第一页时禁用
    const firstBtn = createPageButton('«', 1, currentPage === 1, 'first');
    paginationEl.appendChild(firstBtn);
    
    // 上一页按钮（<）- 在第一页时禁用
    const prevBtn = createPageButton('<', currentPage - 1, currentPage === 1, 'prev');
    paginationEl.appendChild(prevBtn);
    
    // 页码按钮
    const maxVisiblePages = 7;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // 第一页和省略号
    if (startPage > 1) {
        const firstPageBtn = createPageButton('1', 1, false, 'number');
        paginationEl.appendChild(firstPageBtn);
        
        if (startPage > 2) {
            const ellipsisBtn = document.createElement('button');
            ellipsisBtn.className = 'pagination-btn pagination-btn-disabled';
            ellipsisBtn.innerHTML = '...';
            ellipsisBtn.disabled = true;
            paginationEl.appendChild(ellipsisBtn);
        }
    }
    
    // 页码按钮
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = createPageButton(String(i), i, i === currentPage, 'number');
        paginationEl.appendChild(pageBtn);
    }
    
    // 最后一页和省略号
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsisBtn = document.createElement('button');
            ellipsisBtn.className = 'pagination-btn pagination-btn-disabled';
            ellipsisBtn.innerHTML = '...';
            ellipsisBtn.disabled = true;
            paginationEl.appendChild(ellipsisBtn);
        }
        
        const lastPageBtn = createPageButton(String(totalPages), totalPages, false, 'number');
        paginationEl.appendChild(lastPageBtn);
    }
    
    // 下一页按钮（>）- 在最后一页时禁用
    const nextBtn = createPageButton('>', currentPage + 1, currentPage === totalPages, 'next');
    paginationEl.appendChild(nextBtn);
    
    // 末页按钮（»）- 在最后一页时禁用
    const lastBtn = createPageButton('»', totalPages, currentPage === totalPages, 'last');
    paginationEl.appendChild(lastBtn);
}

// 创建分页按钮
function createPageButton(text, page, isDisabled, type) {
    const btn = document.createElement('button');
    btn.type = 'button';
    const isActive = type === 'number' && page === currentPage;
    btn.className = `pagination-btn ${isActive ? 'pagination-btn-active' : ''} ${type === 'first' || type === 'last' || type === 'prev' || type === 'next' ? 'pagination-btn-nav' : ''}`;
    btn.innerHTML = text;
    btn.onclick = function() {
        if (!isDisabled && page >= 1 && page <= Math.ceil(currentServers.length / itemsPerPage)) {
            goToPage(page);
        }
    };
    if (isDisabled) {
        btn.disabled = true;
    }
    return btn;
}

// 跳转到指定页面
function goToPage(page) {
    const totalPages = Math.max(1, Math.ceil(currentServers.length / itemsPerPage));
    if (page >= 1 && page <= totalPages && page !== currentPage) {
        currentPage = page;
        updateServersTable();
        // 滚动到表格顶部
        document.querySelector('.main-content')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// 获取状态徽章
function getStatusBadge(status) {
    const statusConfig = {
        'online': { class: 'bg-success', text: '在线', icon: 'fas fa-check-circle' },
        'offline': { class: 'bg-danger', text: '离线', icon: 'fas fa-times-circle' },
        'maintenance': { class: 'bg-warning', text: '维护中', icon: 'fas fa-tools' }
    };
    const config = statusConfig[status] || statusConfig['offline'];
    return `<span class="badge ${config.class}"><i class="${config.icon} me-1"></i>${config.text}</span>`;
}

// 更新统计信息
function updateStatistics() {
    const totalServers = currentServers.length;
    const onlineServers = currentServers.filter(server => server.status === 'online').length;
    
    document.getElementById('totalServers').textContent = totalServers;
    document.getElementById('onlineServers').textContent = onlineServers;
}

// 添加服务器
async function addAsset() {
    const form = document.getElementById('addAssetForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    // 根据资产类型自动分配类别，无需手动设置
    
    // 验证IP地址格式
    if (!isValidIP(data.ip)) {
        showAlert('请输入有效的IP地址格式！', 'danger');
        return;
    }
    
    try {
        const response = await axios.post('/api/assets', data);
        if (response.data.success) {
            showAlert(response.data.message, 'success');
            document.getElementById('addAssetModal').querySelector('.btn-close').click();
            form.reset();
            loadServers();
        } else {
            showAlert(response.data.message, 'danger');
        }
    } catch (error) {
        console.error('添加服务器失败:', error);
        showAlert('添加服务器失败！', 'danger');
    }
}

// 编辑服务器
function editAsset(assetId) {
    const server = currentServers.find(s => s.id === assetId);
    if (server) {
        document.getElementById('editAssetId').value = server.id;
        document.getElementById('editAssetName').value = server.name;
        document.getElementById('editAssetType').value = server.type;
        document.getElementById('editAssetIp').value = server.ip;
        document.getElementById('editAssetPort').value = server.port;
        document.getElementById('editAssetUsername').value = server.username || '';
        document.getElementById('editAssetPassword').value = server.password || '';
        document.getElementById('editAssetDescription').value = server.description || '';
        
        const modal = new bootstrap.Modal(document.getElementById('editAssetModal'));
        modal.show();
    }
}

// 更新服务器
async function updateAsset() {
    const form = document.getElementById('editAssetForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.action = 'update';
    
    // 验证IP地址格式
    if (!isValidIP(data.ip)) {
        showAlert('请输入有效的IP地址格式！', 'danger');
        return;
    }
    
    try {
        const response = await axios.put(`/api/assets/${data.id}`, data);
        if (response.data.success) {
            showAlert(response.data.message, 'success');
            document.getElementById('editAssetModal').querySelector('.btn-close').click();
            loadServers();
        } else {
            showAlert(response.data.message, 'danger');
        }
    } catch (error) {
        console.error('更新服务器失败:', error);
        showAlert('更新服务器失败！', 'danger');
    }
}

// 重启服务器
async function restartAsset(assetId) {
    try {
        const response = await axios.put(`/api/assets/${assetId}`, { action: 'restart' });
        showAlert(response.data.message, 'success');
        loadServers();
    } catch (error) {
        console.error('重启服务器失败:', error);
        showAlert('重启服务器失败！', 'danger');
    }
}

// 关机服务器
async function shutdownAsset(assetId) {
    try {
        const response = await axios.put(`/api/assets/${assetId}`, { action: 'shutdown' });
        showAlert(response.data.message, 'success');
        loadServers();
    } catch (error) {
        console.error('关机服务器失败:', error);
        showAlert('关机服务器失败！', 'danger');
    }
}


// 删除服务器（由confirmAndDeleteAsset调用）
async function deleteAsset(assetId) {
    try {
        const response = await axios.delete(`/api/assets/${assetId}`);
        if (response.data.success) {
            showAlert(response.data.message || '服务器删除成功！', 'success');
            loadServers();
        } else {
            showAlert(response.data.message || '删除服务器失败！', 'danger');
        }
    } catch (error) {
        console.error('删除服务器失败:', error);
        showAlert('删除服务器失败！', 'danger');
    }
}

// IP地址格式验证
function isValidIP(ip) {
    const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    return ipRegex.test(ip);
}

// 显示提示信息
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
</script>

<style>
/* 更多操作菜单样式 */
.more-actions-menu {
    background-color: #1a1a1a !important;
    border: 1px solid #333 !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(0, 212, 255, 0.1) !important;
    border-radius: 8px !important;
    padding: 6px 0 !important;
    min-width: 120px !important;
    overflow: hidden;
}

.more-actions-item {
    color: #fff !important;
    padding: 10px 18px !important;
    font-size: 14px !important;
    white-space: nowrap !important;
    display: block !important;
    text-decoration: none !important;
    border: none !important;
    background: none !important;
    width: 100% !important;
    text-align: left !important;
    transition: all 0.2s ease !important;
    cursor: pointer !important;
    box-sizing: border-box !important;
}

.more-actions-item:hover {
    background-color: rgba(0, 212, 255, 0.15) !important;
    color: #00d4ff !important;
}

.more-actions-item-danger {
    color: #ff6b7a !important;
}

.more-actions-item-danger:hover {
    background-color: rgba(220, 53, 69, 0.2) !important;
    color: #ff4757 !important;
}

.more-actions-item i {
    margin-right: 8px;
    width: 16px;
    text-align: center;
}

/* 表格样式 */
.table-responsive {
    overflow-x: auto;
    overflow-y: visible;
    width: 100%;
    padding-bottom: 80px; /* 为最后一行展开的菜单预留空间 */
    margin-bottom: 10px;
}

.table {
    width: 100% !important;
    min-width: 1600px !important;
}

.table th, .table td {
    white-space: nowrap;
    padding: 12px 15px;
}

.table tbody tr:last-child td {
    padding-bottom: 80px; /* 最后一行增加底部间距 */
}

.table td:last-child {
    overflow: visible;
    position: relative;
}

/* 分页容器样式 */
.pagination-container {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px 16px;
}

.pagination-info {
    color: rgba(255, 255, 255, 0.8);
    font-size: 14px;
}

/* 分页按钮样式（按图片样式） */
.pagination-buttons {
    display: flex;
    gap: 4px;
    align-items: center;
}

.pagination-btn {
    min-width: 32px;
    height: 32px;
    padding: 6px 12px;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: #fff;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    user-select: none;
}

.pagination-btn:hover:not(.pagination-btn-active):not(:disabled) {
    background-color: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
}

.pagination-btn-active {
    background-color: #5B9BD5 !important;
    border-color: #5B9BD5 !important;
    color: #000 !important;
    font-weight: bold;
    cursor: default;
}

.pagination-btn:disabled,
.pagination-btn-disabled {
    background-color: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.4);
    cursor: not-allowed;
    opacity: 0.6;
}

.pagination-btn-nav {
    font-weight: bold;
}

/* 操作按钮组优化 */
.btn-group .dropdown {
    margin-left: 5px;
}

.btn-group .dropdown-toggle {
    border-left: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer !important;
    pointer-events: auto !important;
    position: relative !important;
    z-index: 1001 !important;
    min-width: 40px !important;
    min-height: 38px !important;
    user-select: none !important;
    -webkit-user-select: none !important;
    touch-action: manipulation !important;
    -webkit-tap-highlight-color: transparent !important;
}

.btn-group .dropdown-toggle:hover {
    background-color: #5a6268 !important;
    transform: scale(1.05) !important;
    transition: all 0.2s ease !important;
}

.btn-group .dropdown-toggle:active {
    background-color: #545b62 !important;
    transform: scale(0.98) !important;
}

.btn-group .dropdown-toggle:focus {
    outline: none !important;
    box-shadow: none !important;
}

/* 下拉图标旋转动画 */
[id^="dropdown-icon-"] {
    -webkit-transition: -webkit-transform 0.2s ease !important;
    -moz-transition: -moz-transform 0.2s ease !important;
    -ms-transition: -ms-transform 0.2s ease !important;
    -o-transition: -o-transform 0.2s ease !important;
    transition: transform 0.2s ease !important;
}

/* 终端样式 */
#terminalOutput {
    background-color: #000;
    color: #0f0;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    height: 100%;
    overflow-y: auto;
    padding: 10px;
    border: none;
    white-space: pre-wrap;
    word-wrap: break-word;
    width: 100%;
    box-sizing: border-box;
}

#terminalInput {
    background-color: #000;
    color: #0f0;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    border: 1px solid rgba(0, 212, 255, 0.3);
}

.prompt {
    color: #00d4ff;
}

.cursor {
    color: #0f0;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

/* 终端窗口调整大小 */
#terminalResizeHandle::before {
    content: '⋱';
    position: absolute;
    right: 3px;
    bottom: 3px;
    font-size: 12px;
    color: #00d4ff;
}

#terminalResizeHandle:hover {
    background: rgba(0, 212, 255, 0.5);
}
</style>

<!-- SSH终端模态框 -->
<div class="modal fade" id="terminalModal" tabindex="-1">
    <div class="modal-dialog" style="max-width: 90%; width: 800px; height: 600px; margin: 5vh auto; display: flex; flex-direction: column;">
        <div class="modal-content" style="background: rgba(0, 0, 0, 0.9); border: 1px solid rgba(0, 212, 255, 0.3); flex: 1; display: flex; flex-direction: column; position: relative; min-height: 0;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0, 212, 255, 0.3); flex-shrink: 0;">
                <h5 class="modal-title text-white">
                    <i class="fas fa-terminal me-2" style="color: #00d4ff;"></i>
                    <span id="terminalTitle">SSH终端</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 0; flex: 1; overflow: hidden; display: flex; flex-direction: column; min-height: 0;">
                <div id="terminalOutput" contenteditable="true" style="outline: none; flex: 1; overflow: auto; min-height: 0;">SSH终端就绪...\n</div>
            </div>
            <!-- Resize handle -->
            <div id="terminalResizeHandle" style="position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; cursor: nw-resize; background: rgba(0, 212, 255, 0.3); border-radius: 0 0 5px 0;"></div>
        </div>
    </div>
</div>

<script>
let currentTerminalAssetId = null;
let currentTerminalSessionId = null;
let currentCommand = '';
let cursorPosition = 0;

async function openTerminal(assetId) {
    const asset = currentServers.find(a => a.id === assetId);
    if (!asset) {
        showAlert('服务器不存在！', 'danger');
        return;
    }
    
    currentTerminalAssetId = assetId;
    document.getElementById('terminalTitle').textContent = `SSH终端 - ${asset.name}`;
    
    const output = document.getElementById('terminalOutput');
    output.innerHTML = '正在连接SSH服务器...<br>';
    
    const modal = new bootstrap.Modal(document.getElementById('terminalModal'));
    modal.show();
    
    // 连接到SSH服务器
    try {
        const response = await axios.post(`/api/assets/${assetId}/terminal/connect`);
        
        if (response.data.success) {
            currentTerminalSessionId = response.data.session_id;
            // 保存初始消息为固定内容，光标由updatePrompt()管理
            const initialMsg = 'SSH连接成功！<br>' + 
                `欢迎连接到 ${asset.name} (${asset.ip})<br>` +
                '输入命令后按回车执行...<br><br>' +
                '<span id="terminal-prompt" class="prompt">[root@localhost ~]# </span>';
            
            output.innerHTML = initialMsg;
            // 立即更新提示符以添加光标
            setTimeout(() => updatePrompt(), 10);
        } else {
            output.innerHTML += `连接失败: ${response.data.error}<br>`;
        }
    } catch (error) {
        output.innerHTML += `连接失败: ${error.message}<br>`;
    }
    
    // 聚焦终端并设置事件监听
    setTimeout(() => {
        output.focus();
        setupTerminalEvents();
    }, 100);
}

function setupTerminalEvents() {
    const output = document.getElementById('terminalOutput');
    
    // 防止重复绑定事件
    if (output._keydownHandler) {
        output.removeEventListener('keydown', output._keydownHandler);
    }
    
    // 创建新的事件处理函数
    output._keydownHandler = function(e) {
        // 阻止所有默认行为，完全由我们的JavaScript控制
        e.preventDefault();
        
        if (e.key === 'Enter') {
            handleCommandInput();
        } else if (e.key === 'Backspace') {
            if (currentCommand.length > 0) {
                currentCommand = currentCommand.slice(0, -1);
                updatePrompt();
            }
        } else if (e.key.length === 1) {
            currentCommand += e.key;
            updatePrompt();
        }
    };
    
    // 添加事件监听
    output.addEventListener('keydown', output._keydownHandler);
}

function updatePrompt() {
    const output = document.getElementById('terminalOutput');
    
    // 尝试直接找到提示符元素
    let promptElement = document.getElementById('terminal-prompt');
    
    if (promptElement) {
        // 直接更新这个元素的内容，转义HTML特殊字符
        const escapedCommand = currentCommand.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        promptElement.textContent = `[root@localhost ~]# ${escapedCommand}`;
        
        // 更新光标
        let cursorElement = promptElement.nextElementSibling;
        if (!cursorElement || !cursorElement.classList.contains('cursor')) {
            // 如果光标不存在，创建它
            cursorElement = document.createElement('span');
            cursorElement.className = 'cursor';
            cursorElement.textContent = '_';
            promptElement.after(cursorElement);
        }
    } else {
        // 如果没有找到，使用旧方法
        const fullHTML = output.innerHTML;
        const lines = fullHTML.split('<br>');
        
        // 找到最后一个包含提示符的行
        let lastPromptIndex = -1;
        for (let i = lines.length - 1; i >= 0; i--) {
            if (lines[i].includes('[root@localhost ~]#')) {
                lastPromptIndex = i;
                break;
            }
        }
        
        if (lastPromptIndex === -1) {
            // 没有找到提示符，添加新的
            const escapedCommand = currentCommand.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            output.innerHTML += '<br><span id="terminal-prompt" class="prompt">[root@localhost ~]# ' + escapedCommand + '</span><span class="cursor">_</span>';
        } else {
            const escapedCommand = currentCommand.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const newPrompt = `<span id="terminal-prompt" class="prompt">[root@localhost ~]# ${escapedCommand}</span><span class="cursor">_</span>`;
            lines[lastPromptIndex] = newPrompt;
            output.innerHTML = lines.join('<br>');
        }
    }
    
    output.scrollTop = output.scrollHeight;
}

async function handleCommandInput() {
    const output = document.getElementById('terminalOutput');
    const command = currentCommand.trim();
    
    if (!command) {
        // 空命令，不执行任何操作，保持当前状态
        return;
    }
    
    // 只移除最后一个提示符行（当前正在输入的行），保留历史命令和输出
    let lines = output.innerHTML.split('<br>');
    let filteredLines = [];
    
    // 从后往前查找，只移除最后一个提示符行
    let foundLastPrompt = false;
    for (let i = lines.length - 1; i >= 0; i--) {
        if (!foundLastPrompt && lines[i].includes('[root@localhost ~]#') && lines[i].includes('id="terminal-prompt"')) {
            foundLastPrompt = true;
            // 跳过这一行（当前正在输入的提示符）
        } else {
            filteredLines.unshift(lines[i]);
        }
    }
    
    // 显示执行的命令
    filteredLines.push(`<span class="prompt">[root@localhost ~]# </span>${command.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}`);
    
    // 更新输出
    output.innerHTML = filteredLines.join('<br>') + '<br>';
    
    // 清空currentCommand
    currentCommand = '';
    
    if (!currentTerminalAssetId || !currentTerminalSessionId) {
        output.innerHTML += '未连接到SSH服务器<br>';
        output.innerHTML += '<br><span id="terminal-prompt" class="prompt">[root@localhost ~]# </span>';
        output.scrollTop = output.scrollHeight;
        setTimeout(() => updatePrompt(), 10);
        return;
    }
    
    try {
        const response = await axios.post(`/api/assets/${currentTerminalAssetId}/terminal`, {
            session_id: currentTerminalSessionId,
            command: command
        });
        
        if (response.data.success) {
            if (response.data.output) {
                output.innerHTML += response.data.output.replace(/\n/g, '<br>');
            }
            if (response.data.error) {
                output.innerHTML += response.data.error.replace(/\n/g, '<br>');
            }
        } else {
            output.innerHTML += `错误: ${response.data.error}<br>`;
        }
    } catch (error) {
        output.innerHTML += `命令执行失败: ${error.message}<br>`;
    }
    
    // 添加新提示符（带ID，光标由updatePrompt()管理）
    output.innerHTML += '<br><span id="terminal-prompt" class="prompt">[root@localhost ~]# </span>';
    output.scrollTop = output.scrollHeight;
    // 立即更新提示符以添加光标，并设置焦点
    setTimeout(() => {
        updatePrompt();
        // 确保终端获得焦点
        output.focus();
    }, 10);
}

// 断开SSH会话
async function disconnectTerminal() {
    if (currentTerminalAssetId && currentTerminalSessionId) {
        try {
            await axios.post(`/api/assets/${currentTerminalAssetId}/terminal/disconnect`, {
                session_id: currentTerminalSessionId
            });
        } catch (error) {
            console.error('断开SSH会话失败:', error);
        }
    }
    currentTerminalAssetId = null;
    currentTerminalSessionId = null;
}

// 模态框关闭时断开SSH会话
document.addEventListener('DOMContentLoaded', function() {
    const terminalModal = document.getElementById('terminalModal');
    if (terminalModal) {
        terminalModal.addEventListener('hidden.bs.modal', function() {
            disconnectTerminal();
        });
    }
    
    // 终端窗口调整大小功能
    const resizeHandle = document.getElementById('terminalResizeHandle');
    const modalDialog = document.querySelector('#terminalModal .modal-dialog');
    
    if (resizeHandle && modalDialog) {
        let isResizing = false;
        let startX, startY, startWidth, startHeight;
        
        resizeHandle.addEventListener('mousedown', function(e) {
            isResizing = true;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = parseInt(document.defaultView.getComputedStyle(modalDialog).width, 10);
            startHeight = parseInt(document.defaultView.getComputedStyle(modalDialog).height, 10);
            
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            
            const width = startWidth + (e.clientX - startX);
            const height = startHeight + (e.clientY - startY);
            
            // 设置最小尺寸
            const minWidth = 400;
            const minHeight = 300;
            
            if (width >= minWidth) {
                modalDialog.style.width = width + 'px';
            }
            if (height >= minHeight) {
                modalDialog.style.height = height + 'px';
            }
        });
        
        document.addEventListener('mouseup', function() {
            isResizing = false;
        });
    }
});
</script>

<!-- SFTP文件管理器模态框 -->
<div class="modal fade" id="fileManagerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: rgba(0, 0, 0, 0.9); border: 1px solid rgba(0, 212, 255, 0.3);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0, 212, 255, 0.3);">
                <h5 class="modal-title text-white">
                    <i class="fas fa-folder me-2" style="color: #00d4ff;"></i>
                    <span id="fileManagerTitle">文件管理器</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-sm btn-secondary" onclick="refreshFileList()">
                        <i class="fas fa-sync me-1"></i>刷新
                    </button>
                    <input type="file" id="fileUploadInput" style="display: none;" onchange="handleFileUpload()">
                    <button class="btn btn-sm btn-primary" onclick="document.getElementById('fileUploadInput').click()">
                        <i class="fas fa-upload me-1"></i>上传文件
                    </button>
                </div>
                <div class="mb-2 d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="goToParentDirectory()" title="返回上级目录">
                        <i class="fas fa-arrow-up"></i> 返回上级
                    </button>
                    <span id="currentPath" class="text-white-50" style="font-family: monospace;">~</span>
                </div>
                <div id="fileList" class="list-group" style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 5px;">
                    <!-- 文件列表将通过JavaScript动态加载 -->
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(0, 212, 255, 0.3);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentFileManagerAssetId = null;
let currentFilePath = '~';

async function openFileManager(assetId) {
    const server = currentServers.find(a => a.id === assetId);
    if (!server) {
        showAlert('服务器不存在！', 'danger');
        return;
    }
    
    currentFileManagerAssetId = assetId;
    currentFilePath = '~';
    document.getElementById('fileManagerTitle').textContent = `文件管理器 - ${server.name}`;
    
    const modal = new bootstrap.Modal(document.getElementById('fileManagerModal'));
    modal.show();
    
    // 加载文件列表
    await loadFileList();
    
    // 更新按钮状态
    updateParentDirectoryButton();
}

async function loadFileList() {
    if (!currentFileManagerAssetId) {
        return;
    }
    
    const fileListDiv = document.getElementById('fileList');
    fileListDiv.innerHTML = '<div class="text-center text-white-50 p-3"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
    
    try {
        const response = await axios.post(`/api/assets/${currentFileManagerAssetId}/sftp/list`, {
            path: currentFilePath
        });
        
        if (response.data.success) {
            const files = response.data.files;
            fileListDiv.innerHTML = '';
            
            if (files.length === 0) {
                fileListDiv.innerHTML = '<div class="text-center text-white-50 p-3">目录为空</div>';
            } else {
                // 先显示目录，再显示文件
                const dirs = files.filter(f => f.is_dir).sort((a, b) => a.name.localeCompare(b.name));
                const regularFiles = files.filter(f => !f.is_dir).sort((a, b) => a.name.localeCompare(b.name));
                
                dirs.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.style.cssText = 'background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-folder text-warning me-2"></i>
                                <span class="text-white">${file.name}</span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="navigateToDirectory('${escapePath(file.name)}')">
                                <i class="fas fa-folder-open"></i> 打开
                            </button>
                        </div>
                    `;
                    fileListDiv.appendChild(item);
                });
                
                regularFiles.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.style.cssText = 'background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file text-info me-2"></i>
                                <span class="text-white">${file.name}</span>
                                <small class="text-white-50 ms-2">(${formatFileSize(file.size)})</small>
                            </div>
                            <button class="btn btn-sm btn-outline-success" onclick="downloadFile('${escapePath(file.name)}')">
                                <i class="fas fa-download"></i> 下载
                            </button>
                        </div>
                    `;
                    fileListDiv.appendChild(item);
                });
            }
            
            // 更新当前路径显示
            document.getElementById('currentPath').textContent = currentFilePath;
            
            // 更新返回上级按钮的启用状态
            updateParentDirectoryButton();
        } else {
            showAlert(`加载文件列表失败: ${response.data.error}`, 'danger');
            fileListDiv.innerHTML = '<div class="text-center text-danger p-3">加载失败</div>';
        }
    } catch (error) {
        console.error('加载文件列表失败:', error);
        showAlert('加载文件列表失败！', 'danger');
        fileListDiv.innerHTML = '<div class="text-center text-danger p-3">加载失败</div>';
    }
}

async function refreshFileList() {
    await loadFileList();
}

async function navigateToDirectory(dirName) {
    // 更新当前路径
    if (currentFilePath === '~' || currentFilePath.endsWith('~/')) {
        currentFilePath = '~/' + dirName;
    } else if (currentFilePath === '/') {
        currentFilePath = '/' + dirName;
    } else {
        currentFilePath += '/' + dirName;
    }
    
    await loadFileList();
    updateParentDirectoryButton();
}

async function goToParentDirectory() {
    // 如果已经在根目录，不执行任何操作
    if (currentFilePath === '~' || currentFilePath === '/' || currentFilePath === '~/') {
        return;
    }
    
    // 处理以 ~ 开头的路径
    if (currentFilePath.startsWith('~/')) {
        const pathParts = currentFilePath.split('/');
        if (pathParts.length > 2) {
            // 移除最后一个目录
            pathParts.pop();
            if (pathParts.length === 1 && pathParts[0] === '~') {
                currentFilePath = '~';
            } else {
                currentFilePath = pathParts.join('/');
            }
        } else {
            currentFilePath = '~';
        }
    } else if (currentFilePath.startsWith('/')) {
        // 处理绝对路径
        const pathParts = currentFilePath.split('/').filter(p => p);
        if (pathParts.length > 0) {
            pathParts.pop();
            currentFilePath = '/' + pathParts.join('/');
        } else {
            currentFilePath = '/';
        }
    }
    
    await loadFileList();
    updateParentDirectoryButton();
}

async function downloadFile(filename) {
    if (!currentFileManagerAssetId) {
        return;
    }
    
    // 构建完整路径
    let fullPath;
    if (currentFilePath === '/') {
        fullPath = currentFilePath + filename;
    } else if (currentFilePath === '~') {
        fullPath = '~/' + filename;
    } else {
        fullPath = currentFilePath + '/' + filename;
    }
    
    console.log('准备下载文件:', fullPath);
    
    try {
        showAlert('正在下载文件...', 'info');
        
        const response = await axios.post(`/api/assets/${currentFileManagerAssetId}/sftp/download`, {
            path: fullPath
        });
        
        if (response.data.success) {
            try {
                // 将base64数据转换为blob并下载
                const base64Data = response.data.data;
                // 使用更稳健的方式处理base64
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray]);
                
                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = response.data.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('文件下载成功！', 'success');
            } catch (error) {
                console.error('下载文件处理失败:', error);
                showAlert('文件下载处理失败！', 'danger');
            }
        } else {
            showAlert(`下载失败: ${response.data.error}`, 'danger');
        }
    } catch (error) {
        console.error('下载文件失败:', error);
        showAlert('下载文件失败！', 'danger');
    }
}

function handleFileUpload() {
    const input = document.getElementById('fileUploadInput');
    const file = input.files[0];
    
    if (!file) {
        return;
    }
    
    if (!currentFileManagerAssetId) {
        return;
    }
    
    // 读取文件内容
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            // 将文件内容转换为base64（改进的方式，避免栈溢出）
            const arrayBuffer = e.target.result;
            const uint8Array = new Uint8Array(arrayBuffer);
            let binaryString = '';
            const chunkSize = 8192; // 分块处理
            
            for (let i = 0; i < uint8Array.length; i += chunkSize) {
                const chunk = uint8Array.subarray(i, i + chunkSize);
                binaryString += String.fromCharCode.apply(null, chunk);
            }
            
            const base64Data = btoa(binaryString);
            
            showAlert('正在上传文件...', 'info');
            
            const response = await axios.post(`/api/assets/${currentFileManagerAssetId}/sftp/upload`, {
                path: currentFilePath,
                filename: file.name,
                data: base64Data
            });
            
            if (response.data.success) {
                showAlert(response.data.message, 'success');
                input.value = '';
                await loadFileList(); // 刷新文件列表
            } else {
                showAlert(`上传失败: ${response.data.error}`, 'danger');
            }
        } catch (error) {
            console.error('上传文件失败:', error);
            showAlert('上传文件失败！', 'danger');
        }
    };
    
    reader.readAsArrayBuffer(file);
}

function escapePath(path) {
    return path.replace(/'/g, "\\'").replace(/"/g, '\\"');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function updateParentDirectoryButton() {
    const buttons = document.querySelectorAll('.btn-outline-secondary');
    const isRoot = currentFilePath === '~' || currentFilePath === '/' || currentFilePath === '~/';
    buttons.forEach(btn => {
        if (btn.textContent.includes('返回上级')) {
            if (isRoot) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            } else {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }
    });
}
</script>

{% endblock %}
